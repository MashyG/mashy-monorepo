# Next

## è·¯ç”±ï¼ˆAppRouter && PageRouterï¼‰

> Nextjs 14+ é»˜è®¤è·¯ç”±æ¨¡å¼ä¸º AppRouter
> ä¼˜å…ˆçº§ï¼šAppRouter > PageRouter

- `app/page.tsx` å¯¹åº”è·¯ç”± `/`
- `app/about/page.tsx` å¯¹åº”è·¯ç”± `/about`

## å®šä¹‰å¸ƒå±€ï¼ˆLayoutsï¼‰

> layout ä¼šåŒ…è£¹åŒå±‚çº§çš„ Page

### æ ¹å¸ƒå±€ï¼ˆRoot Layoutï¼‰

> å¸ƒå±€æ”¯æŒåµŒå¥—ï¼Œæœ€é¡¶å±‚çš„å¸ƒå±€æˆ‘ä»¬ç§°ä¹‹ä¸ºæ ¹å¸ƒå±€ï¼ˆRoot Layoutï¼‰

```tsx
// app/layout.tsx
import "./globals.css";
import { Inter } from "next/font/google";

const inter = Inter({ subsets: ["latin"] });

export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body className={inter.className}>{children}</body>
    </html>
  );
}
```

**æ³¨æ„**

1. `app` ç›®å½•å¿…é¡»åŒ…å«æ ¹å¸ƒå±€ï¼Œä¹Ÿå°±æ˜¯ `app/layout.tsx` è¿™ä¸ªæ–‡ä»¶æ˜¯å¿…éœ€çš„
2. æ ¹å¸ƒå±€å¿…é¡»åŒ…å« `html` å’Œ `body` æ ‡ç­¾ï¼Œå…¶ä»–å¸ƒå±€ä¸èƒ½åŒ…å«è¿™äº›æ ‡ç­¾
3. å¯ä»¥ä½¿ç”¨è·¯ç”±ç»„åˆ›å»ºå¤šä¸ªæ ¹å¸ƒå±€
4. é»˜è®¤æ ¹å¸ƒå±€æ˜¯æœåŠ¡ç«¯ç»„ä»¶ï¼Œä¸”ä¸èƒ½è®¾ç½®ä¸ºå®¢æˆ·ç«¯ç»„ä»¶

### å®šä¹‰æ¨¡æ¿ï¼ˆTemplatesï¼‰

> æ¨¡æ¿ç±»ä¼¼äºå¸ƒå±€ï¼Œå®ƒä¹Ÿä¼šä¼ å…¥æ¯ä¸ªå­å¸ƒå±€æˆ–è€…é¡µé¢ã€‚ä½†**ä¸ä¼šåƒå¸ƒå±€é‚£æ ·ç»´æŒçŠ¶æ€**ã€‚

**æ³¨æ„ï¼š** layout ä¼šåŒ…è£¹ templateï¼Œtemplate åˆä¼šåŒ…è£¹ pageã€‚

```tsx
<Layout>
  {/* æ¨¡æ¿éœ€è¦ç»™ä¸€ä¸ªå”¯ä¸€çš„ key */}
  <Template key={routeParam}>{children}</Template>
</Layout>
```

### å®šä¹‰åŠ è½½ç•Œé¢ï¼ˆLoading UIï¼‰

```tsx
// xxx/loading.tsx
export default function AboutLoading() {
  return <>Loading about...</>;
}

// xxx/page.tsx
import { use } from "react";

async function getData() {
  await new Promise((resolve) => setTimeout(resolve, 3000));
  return {
    message: "Hello, About!",
  };
}
export default function AboutPage(props) {
  // const { message } = await getData()
  const { message } = use(getData());
  return <h1>{message}</h1>;
}
```

> **åŸç†**ï¼šåˆ©ç”¨ Suspense ,å½“å‘ç”Ÿè·¯ç”±å˜åŒ–çš„æ—¶å€™ï¼Œç«‹åˆ»å±•ç¤º fallback UIï¼Œç­‰åŠ è½½å®Œæˆåï¼Œå±•ç¤ºæ•°æ®ã€‚

```tsx
// About ä¼š throw ä¸€ä¸ªæ•°æ®åŠ è½½çš„ promiseï¼ŒSuspense ä¼šæ•è·è¿™ä¸ª promiseï¼Œè¿½åŠ ä¸€ä¸ª then å‡½æ•°ï¼Œthen å‡½æ•°ä¸­å®ç°æ›¿æ¢ fallback UI ã€‚å½“æ•°æ®åŠ è½½å®Œæ¯•ï¼Œpromise è¿›å…¥ resolve çŠ¶æ€ï¼Œthen å‡½æ•°æ‰§è¡Œï¼Œäºæ˜¯æ›´æ–°æ›¿æ¢ fallback UIã€‚
<Suspense fallback={<Spinner />}>
  <AboutPage />
</Suspense>
```

### å®šä¹‰é”™è¯¯å¤„ç†ï¼ˆError Handlingï¼‰

> ç”¨æ¥åˆ›å»ºå‘ç”Ÿé”™è¯¯æ—¶çš„å±•ç¤º UI

```tsx
"use client"; // é”™è¯¯ç»„ä»¶å¿…é¡»æ˜¯å®¢æˆ·ç«¯ç»„ä»¶
// xxx/error.tsx
import { useEffect } from "react";

export default function Error({ error, reset }) {
  useEffect(() => {
    console.error(error);
  }, [error]);

  return (
    <div>
      <h2>Something went wrong!</h2>
      <button
        onClick={
          // å°è¯•æ¢å¤
          () => reset()
        }
      >
        Try again
      </button>
    </div>
  );
}
```

**å…¨å±€é”™è¯¯æ•è·**

```tsx
"use client";
// app/error.tsx
export default function GlobalError({ error, reset }) {
  return (
    <html>
      <body>
        <h2>Something went wrong!</h2>
        <button onClick={() => reset()}>Try again</button>
      </body>
    </html>
  );
}
```

### å®šä¹‰ 404 é¡µé¢

> ç‰¹æ®Šæ–‡ä»¶ï¼šnot-found.tsx

```tsx
// xxx/not-found.tsx
import Link from "next/link";

export default function NotFound() {
  return (
    <div>
      <h2>Not Found</h2>
      <p>Could not find requested resource</p>
      <Link href="/">Return Home</Link>
    </div>
  );
}
```

### æ€»ç»“

```tsx
app
  â”œâ”€â”€ page.tsx
  â”œâ”€â”€ layout.tsx
  â”œâ”€â”€ template.tsx
  â”œâ”€â”€ loading.tsx
  â”œâ”€â”€ error.tsx
  â””â”€â”€ not-found.tsx
  â”œâ”€â”€ about
  â”‚   â””â”€â”€ page.tsx
```

## å¯¼èˆª

### ä½¿ç”¨ <Link> ç»„ä»¶

> ä¸€ä¸ªæ‹“å±•äº†åŸç”Ÿ HTML <a> æ ‡ç­¾çš„å†…ç½®ç»„ä»¶ï¼Œç”¨æ¥å®ç°é¢„è·å–ï¼ˆprefetchingï¼‰ å’Œå®¢æˆ·ç«¯è·¯ç”±å¯¼èˆª

```tsx
import Link from "next/link";

// åŸºç¡€ç”¨æ³•
function About() {
  return <Link href="/about">About</Link>;
}

// åŠ¨æ€æ¸²æŸ“
function PostList({ posts }) {
  return (
    <ul>
      {posts.map((post) => (
        <li key={post.id}>
          <Link href={`/blog/${post.id}`}>{post.title}</Link>
        </li>
      ))}
    </ul>
  );
}

// è·å–å½“å‰URLè·¯å¾„ï¼ˆå¿…é¡»åœ¨å®¢æˆ·ç«¯ä½¿ç”¨"use client"ï¼‰
usePathname();
```

### ä½¿ç”¨ useRouter() Hookï¼ˆå®¢æˆ·ç«¯ç»„ä»¶ï¼‰

```tsx
// è¯¥ hook éœ€è¦åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä¸­
"use client";

import { useRouter } from "next/navigation";

export default function Page() {
  const router = useRouter();

  return (
    <button type="button" onClick={() => router.push("/about")}>
      About
    </button>
  );
}
```

### ä½¿ç”¨ redirect å‡½æ•°ï¼ˆæœåŠ¡ç«¯ç»„ä»¶ï¼‰

> å®¢æˆ·ç«¯ç»„ä»¶ä½¿ç”¨ `useRouter()` hookï¼ŒæœåŠ¡ç«¯ç»„ä»¶åˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ `redirect()` å‡½æ•°

```tsx
redirect("/login");
```

### ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ History API

> æµè§ˆå™¨åŸç”Ÿçš„ `window.history.pushState` å’Œ `window.history.replaceState` æ–¹æ³•æ›´æ–°æµè§ˆå™¨çš„å†å²è®°å½•å †æ ˆ.é€šå¸¸ä¸ usePathnameï¼ˆè·å–è·¯å¾„åçš„ hookï¼‰ å’Œ useSearchParamsï¼ˆè·å–é¡µé¢å‚æ•°çš„ hookï¼‰ ä¸€èµ·ä½¿ç”¨

## åŠ¨æ€è·¯ç”±ã€è·¯ç”±ç»„ã€å¹³è¡Œè·¯ç”±å’Œæ‹¦æˆªè·¯ç”±

### åŠ¨æ€è·¯ç”±ï¼ˆDynamic Routesï¼‰

#### `[folderName]`

> ä½¿ç”¨åŠ¨æ€è·¯ç”±ï¼Œä½ éœ€è¦å°†æ–‡ä»¶å¤¹çš„åå­—ç”¨æ–¹æ‹¬å·æ‹¬ä½ï¼Œæ¯”å¦‚ [id]ã€[slug]ã€‚è¿™ä¸ªè·¯ç”±çš„åå­—ä¼šä½œä¸º params prop ä¼ ç»™å¸ƒå±€ã€ é¡µé¢ã€ è·¯ç”±å¤„ç†ç¨‹åº ä»¥åŠ generateMetadata å‡½æ•°ã€‚

```tsx
// app/about/[mashy]/page.tsx
export default function Page({ params }: any) {
  return <div>Params: {params.mashy}</div>;
}
```

#### `[...folderName]`

```tsx
// app/about/[mashy]/[chen]/page.tsx
export default function Page({ params }: any) {
  return <div>Params: {JSON.stringify(params)}</div>; // {"mashy":"xxx","chen":"xxx"}
}
```

#### `[[...folderName]]`

> åœ¨å‘½åæ–‡ä»¶å¤¹çš„æ—¶å€™ï¼Œå¦‚æœä½ åœ¨åŒæ–¹æ‹¬å·å†…æ·»åŠ çœç•¥å·ï¼Œæ¯”å¦‚ `[[...folderName]]`ï¼Œè¿™è¡¨ç¤ºå¯é€‰çš„æ•è·æ‰€æœ‰åé¢æ‰€æœ‰çš„è·¯ç”±ç‰‡æ®µã€‚
> ä¸ä¸Šä¸€ç§çš„åŒºåˆ«å°±åœ¨äºï¼Œä¸å¸¦å‚æ•°çš„è·¯ç”±ä¹Ÿä¼šè¢«åŒ¹é…ï¼ˆå°±æ¯”å¦‚ `/about`ï¼‰

### è·¯ç”±ç»„ï¼ˆRoute groupsï¼‰

#### æŒ‰é€»è¾‘åˆ†ç»„

> å°†è·¯ç”±æŒ‰é€»è¾‘åˆ†ç»„ï¼Œä½†ä¸å½±å“ URL è·¯å¾„ï¼š

```tsx
app
  â”œâ”€â”€ page.tsx
  â”œâ”€â”€ (AI)
      â”œâ”€â”€ xxx
          â””â”€â”€ page.tsx
      â”œâ”€â”€ yyy
          â””â”€â”€ page.tsx
  â”œâ”€â”€ (file)
      â”œâ”€â”€ xxx
          â””â”€â”€ page.tsx
      â”œâ”€â”€ yyy
          â””â”€â”€ page.tsx
```

#### åˆ›å»ºä¸åŒå¸ƒå±€

> å€ŸåŠ©è·¯ç”±ç»„ï¼Œå³ä¾¿åœ¨åŒä¸€å±‚çº§ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºä¸åŒçš„å¸ƒå±€ï¼š

```tsx
app
  â”œâ”€â”€ page.tsx
  â”œâ”€â”€ (AI)
      â”œâ”€â”€ layout.tsx  // âˆš
      â”œâ”€â”€ xxx
          â””â”€â”€ page.tsx
      â”œâ”€â”€ yyy
          â””â”€â”€ page.tsx
  â”œâ”€â”€ (file)
      â”œâ”€â”€ layout.tsx  // âˆš
      â”œâ”€â”€ xxx
          â””â”€â”€ page.tsx
      â”œâ”€â”€ yyy
          â””â”€â”€ page.tsx
```

#### åˆ›å»ºå¤šä¸ªæ ¹å¸ƒå±€

```tsx
app
  â”œâ”€â”€ (AI)
      â”œâ”€â”€ layout.tsx  // âˆš è¦æœ‰ <html> å’Œ <body> æ ‡ç­¾
      â”œâ”€â”€ page.tsx
      â”œâ”€â”€ xxx
          â””â”€â”€ page.tsx
      â”œâ”€â”€ yyy
          â””â”€â”€ page.tsx
  â”œâ”€â”€ (file)
      â”œâ”€â”€ layout.tsx  // âˆš è¦æœ‰ <html> å’Œ <body> æ ‡ç­¾
      â”œâ”€â”€ xxx
          â””â”€â”€ page.tsx
      â”œâ”€â”€ yyy
          â””â”€â”€ page.tsx
```

**æ³¨æ„**

- è·¯ç”±ç»„çš„å‘½åé™¤äº†ç”¨äºç»„ç»‡ä¹‹å¤–å¹¶æ— ç‰¹æ®Šæ„ä¹‰ã€‚å®ƒä»¬ä¸ä¼šå½±å“ URL è·¯å¾„ã€‚
- æ³¨æ„ä¸è¦è§£æä¸ºç›¸åŒçš„ URL è·¯å¾„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå› ä¸ºè·¯ç”±ç»„ä¸å½±å“ URL è·¯å¾„ï¼Œæ‰€ä»¥ `(marketing)/about/page.js` å’Œ `(shop)/about/page.js` éƒ½ä¼šè§£æä¸º `/about`ï¼Œè¿™ä¼šå¯¼è‡´æŠ¥é”™ã€‚
- åˆ›å»ºå¤šä¸ªæ ¹å¸ƒå±€çš„æ—¶å€™ï¼Œå› ä¸ºåˆ é™¤äº†é¡¶å±‚çš„ `app/layout.js` æ–‡ä»¶ï¼Œè®¿é—® /ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥ `app/page.js` éœ€è¦å®šä¹‰åœ¨å…¶ä¸­ä¸€ä¸ªè·¯ç”±ç»„ä¸­ã€‚
- è·¨æ ¹å¸ƒå±€å¯¼èˆªä¼šå¯¼è‡´é¡µé¢å®Œå…¨é‡æ–°åŠ è½½ï¼Œå°±æ¯”å¦‚ä½¿ç”¨ `app/(shop)/layout.js` æ ¹å¸ƒå±€çš„ `/cart` è·³è½¬åˆ°ä½¿ç”¨ `app/(marketing)/layout.js` æ ¹å¸ƒå±€çš„ `/blog` ä¼šå¯¼è‡´é¡µé¢é‡æ–°åŠ è½½ï¼ˆfull page loadï¼‰ã€‚

### å¹³è¡Œè·¯ç”±ï¼ˆParallel Routesï¼‰

> å¹³è¡Œè·¯ç”±å¯ä»¥ä½¿ä½ åœ¨åŒä¸€ä¸ªå¸ƒå±€ä¸­åŒæ—¶æˆ–è€…æœ‰æ¡ä»¶çš„æ¸²æŸ“ä¸€ä¸ªæˆ–è€…å¤šä¸ªé¡µé¢ï¼ˆç±»ä¼¼äº Vue çš„æ’æ§½åŠŸèƒ½ï¼‰ã€‚

> **å¹³è¡Œè·¯ç”±çš„ä½¿ç”¨æ–¹å¼æ˜¯å°†æ–‡ä»¶å¤¹ä»¥ @ ä½œä¸ºå¼€å¤´è¿›è¡Œå‘½å**

- æ¡ä»¶æ¸²æŸ“ï¼š`isLogin ? <content /> : <login />`
- ç‹¬ç«‹è·¯ç”±å¤„ç†ï¼šloadingã€error
- å­å¯¼èˆªï¼š@left/oneã€@left/two
- default.tsx

å…·ä½“æ’æ§½ä¸­æ˜¾ç¤ºçš„å†…å®¹å…¶å®è·Ÿå¯¼èˆªçš„ç±»å‹æœ‰å…³ï¼š

- å¦‚æœæ˜¯è½¯å¯¼èˆªï¼ˆSoft Navigationï¼Œæ¯”å¦‚é€šè¿‡ <Link /> æ ‡ç­¾ï¼‰ï¼Œåœ¨å¯¼èˆªæ—¶ï¼ŒNext.js å°†æ‰§è¡Œéƒ¨åˆ†æ¸²æŸ“ï¼Œæ›´æ”¹æ’æ§½çš„å†…å®¹ï¼Œå¦‚æœå®ƒä»¬ä¸å½“å‰ URL ä¸åŒ¹é…ï¼Œç»´æŒä¹‹å‰çš„çŠ¶æ€
- å¦‚æœæ˜¯ç¡¬å¯¼èˆªï¼ˆHard Navigationï¼Œæ¯”å¦‚æµè§ˆå™¨åˆ·æ–°é¡µé¢ï¼‰ï¼Œå› ä¸º Next.js æ— æ³•ç¡®å®šä¸å½“å‰ URL ä¸åŒ¹é…çš„æ’æ§½çš„çŠ¶æ€ï¼Œæ‰€ä»¥ä¼šæ¸²æŸ“ 404 é”™è¯¯

### æ‹¦æˆªè·¯ç”±

> æ‹¦æˆªè·¯ç”±å…è®¸ä½ åœ¨å½“å‰è·¯ç”±æ‹¦æˆªå…¶ä»–è·¯ç”±åœ°å€å¹¶åœ¨å½“å‰è·¯ç”±ä¸­å±•ç¤ºå†…å®¹ã€‚

åœ¨ Next.js ä¸­ï¼Œå®ç°æ‹¦æˆªè·¯ç”±éœ€è¦ä½ åœ¨å‘½åæ–‡ä»¶å¤¹çš„æ—¶å€™ä»¥ (..) å¼€å¤´ï¼Œå…¶ä¸­ï¼š

- (.) è¡¨ç¤ºåŒ¹é…åŒä¸€å±‚çº§
- (..) è¡¨ç¤ºåŒ¹é…ä¸Šä¸€å±‚çº§
- (..)(..) è¡¨ç¤ºåŒ¹é…ä¸Šä¸Šå±‚çº§ã€‚
- (...) è¡¨ç¤ºåŒ¹é…æ ¹ç›®å½•

```js
// /food/(..)photoå¯¹åº”çš„è·¯ç”±æ˜¯ /food/photoï¼Œè¦æ‹¦æˆªçš„è·¯ç”±æ˜¯ /photoï¼Œä¸¤è€…åªå·®äº†ä¸€ä¸ªå±‚çº§ï¼Œæ‰€ä»¥ä½¿ç”¨ (..)
app
  â”œâ”€â”€ page.tsx
  â”œâ”€â”€ food
      â”œâ”€â”€ (..)photo
          â”œâ”€â”€ [id]
              â”œâ”€â”€ page.tsx
      â”œâ”€â”€ layout.tsx
  â”œâ”€â”€ photo
      â”œâ”€â”€ [id]
          â”œâ”€â”€ page.tsx
```

## è·¯ç”±å¤„ç†ç¨‹åº

> è·¯ç”±å¤„ç†ç¨‹åºæ˜¯æŒ‡ä½¿ç”¨ `Web Request` å’Œ `Response API` å¯¹äºç»™å®šçš„è·¯ç”±è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚
> ç®€å•çš„æ¥è¯´ï¼Œå‰åç«¯åˆ†ç¦»æ¶æ„ä¸­ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´é€šè¿‡ API æ¥å£æ¥äº¤äº’ã€‚è¿™ä¸ªâ€œAPI æ¥å£â€åœ¨ Next.js ä¸­æœ‰ä¸ªæ›´ä¸ºæ­£å¼çš„ç§°å‘¼ï¼Œå°±æ˜¯è·¯ç”±å¤„ç†ç¨‹åºã€‚
> è¯¥æ–‡ä»¶å¿…é¡»åœ¨ app ç›®å½•ä¸‹ï¼Œå¯ä»¥åœ¨ app åµŒå¥—çš„æ–‡ä»¶å¤¹ä¸‹ï¼Œä½†æ˜¯è¦æ³¨æ„ `page.tsx` å’Œ `route.ts` ä¸èƒ½åœ¨åŒä¸€å±‚çº§åŒæ—¶å­˜åœ¨ã€‚
> `page.tsx` å’Œ `route.ts` æœ¬è´¨ä¸Šéƒ½æ˜¯å¯¹è·¯ç”±çš„å“åº”ã€‚`page.tsx` ä¸»è¦è´Ÿè´£æ¸²æŸ“ UIï¼Œ`route.ts` ä¸»è¦è´Ÿè´£å¤„ç†è¯·æ±‚

```ts
import { NextResponse } from "next/server";

export async function GET() {
  const res = await fetch("https://jsonplaceholder.typicode.com/posts");
  const data = await res.json();

  // return Response.json({ data }); // åŸç”Ÿä¹Ÿå¯ï¼ŒNextæ¨èä¸‹é¢çš„
  return NextResponse.json({ data });
}
```

### æ”¯æŒæ–¹æ³•

> Next.js æ”¯æŒ GETã€POSTã€PUTã€PATCHã€DELETEã€HEAD å’Œ OPTIONS è¿™äº› HTTP è¯·æ±‚æ–¹æ³•ã€‚

### è¯·æ±‚å‚æ•°

```ts
export async function GET(request, context) {}
// requestï¼šrequest å¯¹è±¡æ˜¯ä¸€ä¸ª NextRequest å¯¹è±¡ï¼Œå®ƒæ˜¯åŸºäº Web Request API çš„æ‰©å±•ã€‚ä½¿ç”¨ request ï¼Œä½ å¯ä»¥å¿«æ·è¯»å– cookies å’Œå¤„ç† URL
// context åªæœ‰ä¸€ä¸ªå€¼å°±æ˜¯ paramsï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å«å½“å‰åŠ¨æ€è·¯ç”±å‚æ•°çš„å¯¹è±¡
```

### ç¼“å­˜

> é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Response å¯¹è±¡ï¼ˆNextResponse ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼‰çš„ GET è¯·æ±‚ä¼šè¢«ç¼“å­˜ã€‚
> åœ¨æ„å»ºçš„æ—¶å€™,è¢«é¢„æ¸²æŸ“ä¸ºé™æ€çš„å†…å®¹

#### é€€å‡ºç¼“å­˜æ–¹æ³•

1. GET è¯·æ±‚ä½¿ç”¨ Request å¯¹è±¡
2. æ·»åŠ å…¶ä»– HTTP æ–¹æ³•ï¼Œæ¯”å¦‚ POST
3. ä½¿ç”¨åƒ cookiesã€headers è¿™æ ·çš„åŠ¨æ€å‡½æ•°
4. è·¯ç”±æ®µé…ç½®é¡¹æ‰‹åŠ¨å£°æ˜ä¸ºåŠ¨æ€æ¨¡å¼

```ts
export async function GET(request) {
  const token = request.cookies.get("token"); // 3
  return Response.json({ data: new Date().toLocaleTimeString() }); // 1
}

// 2
export async function POST() {
  console.log("POST /api/time");
  return Response.json({ data: new Date().toLocaleTimeString() });
}

export const dynamic = "force-dynamic"; // 4
```

**é™¤äº†é€€å‡ºç¼“å­˜ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ç¼“å­˜çš„æ—¶æ•ˆï¼Œé€‚ç”¨äºä¸€äº›é‡è¦æ€§ä½ã€æ—¶æ•ˆæ€§ä½çš„é¡µé¢**

1. è·¯ç”±æ®µé…ç½®é¡¹
2. ä½¿ç”¨ `next.revalidate` é€‰é¡¹

```ts
export const revalidate = 10; // 1 è¡¨ç¤ºè®¾ç½®é‡æ–°éªŒè¯é¢‘ç‡ä¸º 10s

export async function GET() {
  return Response.json({ data: new Date().toLocaleTimeString() });
}

// 2
// Next.js æ‹“å±•äº†åŸç”Ÿçš„ fetch æ–¹æ³•ï¼Œä¼šè‡ªåŠ¨ç¼“å­˜ fetch çš„ç»“æœã€‚ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ next.revalidate è®¾ç½® fetch è¯·æ±‚çš„é‡æ–°éªŒè¯æ—¶é—´
export async function GET() {
  const res = await fetch("https://api.thecatapi.com/v1/images/search", {
    next: { revalidate: 5 }, //  æ¯ 5 ç§’é‡æ–°éªŒè¯
  });
  const data = await res.json();
  console.log(data);
  return Response.json(data);
}
```

## è·¯ç”±ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰

> ä½¿ç”¨ä¸­é—´ä»¶ï¼Œä½ å¯ä»¥æ‹¦æˆªå¹¶æ§åˆ¶åº”ç”¨é‡Œçš„æ‰€æœ‰è¯·æ±‚å’Œå“åº”ã€‚
> ä¸­é—´ä»¶æ–‡ä»¶å¿…é¡»åœ¨æ ¹ç›®å½•ä¸‹

> æ¯”å¦‚ä½ å¯ä»¥åŸºäºä¼ å…¥çš„è¯·æ±‚ï¼Œé‡å†™ã€é‡å®šå‘ã€ä¿®æ”¹è¯·æ±‚æˆ–å“åº”å¤´ã€ç”šè‡³ç›´æ¥å“åº”å†…å®¹ã€‚ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„åº”ç”¨å°±æ˜¯é‰´æƒï¼Œåœ¨æ‰“å¼€é¡µé¢æ¸²æŸ“å…·ä½“çš„å†…å®¹å‰ï¼Œå…ˆåˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œå¦‚æœæœªç™»å½•ï¼Œåˆ™è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚

```ts
// middleware.ts
import { NextResponse } from "next/server";

// ä¸­é—´ä»¶å¯ä»¥æ˜¯ async å‡½æ•°ï¼Œå¦‚æœä½¿ç”¨äº† await
export function middleware(request: Request) {
  return NextResponse.redirect(new URL("/", request.url));
}

// è®¾ç½®åŒ¹é…è·¯å¾„
// matcher ä¸ä»…æ”¯æŒå­—ç¬¦ä¸²å½¢å¼ï¼Œä¹Ÿæ”¯æŒæ•°ç»„å½¢å¼ï¼Œç”¨äºåŒ¹é…å¤šä¸ªè·¯å¾„
export const config = {
  // matcher: "/about/:path*",
  matcher: ["/about/:path*", "/boast/:path*"],
};
```

> `path-to-regexp` é€šè¿‡åœ¨å‚æ•°åå‰åŠ ä¸€ä¸ªå†’å·æ¥å®šä¹‰å‘½åå‚æ•°ï¼ˆNamed Parametersï¼‰
>
> å‘½åå‚æ•°çš„é»˜è®¤åŒ¹é…é€»è¾‘æ˜¯ `[^/]+`ï¼Œä½†ä½ ä¹Ÿå¯ä»¥åœ¨å‘½åå‚æ•°ååŠ ä¸€ä¸ªæ‹¬å·ï¼Œåœ¨å…¶ä¸­è‡ªå®šä¹‰å‘½åå‚æ•°çš„åŒ¹é…é€»è¾‘ï¼Œæ¯”å¦‚ `/about/icon-:foo(\\d+).png` åŒ¹é… `/about/icon-1.png`ï¼Œä½†ä¸åŒ¹é… `/about/icon-a.png`ã€‚
>
> å‘½åå‚æ•°å¯ä»¥ä½¿ç”¨ä¿®é¥°ç¬¦ï¼Œ**å…¶ä¸­ \* è¡¨ç¤º 0 ä¸ªæˆ– 1 ä¸ªæˆ–å¤šä¸ªï¼Œ?è¡¨ç¤º 0 ä¸ªæˆ– 1 ä¸ªï¼Œ+è¡¨ç¤º 1 ä¸ªæˆ–å¤šä¸ª**ï¼Œæ¯”å¦‚
>
> - `/about/:path*` åŒ¹é… `/about`ã€`/about/xxx`ã€`/about/xxx/xxx`
> - `/about/:path?` åŒ¹é… `/about`ã€`/about/xxx`
> - `/about/:path+` åŒ¹é… `/about/xxx`ã€`/about/xxx/xxx`
>
> ä¹Ÿå¯ä»¥åœ¨åœ†æ‹¬å·ä¸­ä½¿ç”¨æ ‡å‡†çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ¯”å¦‚ `/about/(.*)` ç­‰åŒäº `/about/:path*`ï¼Œæ¯”å¦‚ Â· åŒ¹é… `/about` å’Œ `/settings`ï¼Œä¸åŒ¹é…å…¶ä»–çš„åœ°å€ã€‚`/user-(ya|yu)` åŒ¹é… `/user-ya` å’Œ `/user-yu`ã€‚

**æ³¨æ„**ï¼šè·¯å¾„å¿…é¡»ä»¥ /å¼€å¤´ã€‚matcher çš„å€¼å¿…é¡»æ˜¯å¸¸é‡ï¼Œè¿™æ ·å¯ä»¥åœ¨æ„å»ºçš„æ—¶å€™è¢«é™æ€åˆ†æã€‚ä½¿ç”¨å˜é‡ä¹‹ç±»çš„åŠ¨æ€å€¼ä¼šè¢«å¿½ç•¥ã€‚

```ts
export const config = {
  matcher: [
    /*
     * åŒ¹é…æ‰€æœ‰çš„è·¯å¾„é™¤äº†ä»¥è¿™äº›ä½œä¸ºå¼€å¤´çš„ï¼š
     * - api (API routes)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    "/((?!api|_next/static|_next/image|favicon.ico).*)",
  ],
};
```

### matcher è¿˜å¯ä»¥åˆ¤æ–­æŸ¥è¯¢å‚æ•°ã€cookiesã€headers

```ts
// ä¸ä»…åŒ¹é…äº†è·¯ç”±åœ°å€ï¼Œè¿˜è¦æ±‚ header çš„ Authorization å¿…é¡»æ˜¯ Bearer Tokenï¼ŒæŸ¥è¯¢å‚æ•°çš„ userId ä¸º 123ï¼Œä¸” cookie é‡Œçš„ session å€¼ä¸æ˜¯ activeã€‚
export const config = {
  matcher: [
    {
      source: "/api/*",
      has: [
        { type: "header", key: "Authorization", value: "Bearer Token" },
        { type: "query", key: "userId", value: "123" },
      ],
      missing: [{ type: "cookie", key: "session", value: "active" }],
    },
  ],
};
```

### åˆ©ç”¨ `NextResponse.next()` è¯»å–å’Œè®¾ç½® `cookies` æˆ– `headers`

```ts
// middleware.ts
import { NextResponse } from "next/server";

export function middleware(request) {
  // å‡è®¾ä¼ å…¥çš„è¯·æ±‚ header é‡Œ "Cookie:nextjs=fast"
  let cookie = request.cookies.get("nextjs");
  console.log(cookie); // => { name: 'nextjs', value: 'fast', Path: '/' }
  const allCookies = request.cookies.getAll();
  console.log(allCookies); // => [{ name: 'nextjs', value: 'fast' }]

  request.cookies.has("nextjs"); // => true
  request.cookies.delete("nextjs");
  request.cookies.has("nextjs"); // => false

  // è®¾ç½® cookies
  const response = NextResponse.next();
  response.cookies.set("vercel", "fast");
  response.cookies.set({
    name: "vercel",
    value: "fast",
    path: "/",
  });
  cookie = response.cookies.get("vercel");
  console.log(cookie); // => { name: 'vercel', value: 'fast', Path: '/' }

  // å“åº” header ä¸º `Set-Cookie:vercel=fast;path=/test`
  // return response

  //  clone è¯·æ±‚æ ‡å¤´
  const requestHeaders = new Headers(request.headers);
  requestHeaders.set("x-hello-from-middleware1", "hello");

  // ä½ ä¹Ÿå¯ä»¥åœ¨ NextResponse.rewrite ä¸­è®¾ç½®è¯·æ±‚æ ‡å¤´
  const response = NextResponse.next({
    request: {
      // è®¾ç½®æ–°è¯·æ±‚æ ‡å¤´
      headers: requestHeaders,
    },
  });

  // è®¾ç½®æ–°å“åº”æ ‡å¤´ `x-hello-from-middleware2`
  response.headers.set("x-hello-from-middleware2", "hello");
  return response;
}
```

### åˆ©ç”¨ `NextResponse.next()` è®¾ç½® `CORS`

```ts
import { NextResponse } from "next/server";

const allowedOrigins = ["https://xxx.com", "https://my-app.org"];

const corsOptions = {
  "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type, Authorization",
};

export function middleware(request) {
  // Check the origin from the request
  const origin = request.headers.get("origin") ?? "";
  const isAllowedOrigin = allowedOrigins.includes(origin);

  // Handle preflighted requests
  const isPreflight = request.method === "OPTIONS";

  if (isPreflight) {
    const preflightHeaders = {
      ...(isAllowedOrigin && { "Access-Control-Allow-Origin": origin }),
      ...corsOptions,
    };
    return NextResponse.json({}, { headers: preflightHeaders });
  }

  // Handle simple requests
  const response = NextResponse.next();

  if (isAllowedOrigin) {
    response.headers.set("Access-Control-Allow-Origin", origin);
  }

  Object.entries(corsOptions).forEach(([key, value]) => {
    response.headers.set(key, value);
  });

  return response;
}

export const config = {
  matcher: "/api/:path*",
};
```

### ç›´æ¥å“åº”ï¼šä½¿ç”¨ NextResponse è®¾ç½®è¿”å›çš„ Response

```ts
return new NextResponse(
  JSON.stringify({ success: false, message: "authentication failed" }),
  { status: 401, headers: { "content-type": "application/json" } }
);
```

### è·¯ç”±çš„å“åº”æ‰§è¡Œé¡ºåº

1. headersï¼ˆ`next.config.js`ï¼‰
2. redirectsï¼ˆ`next.config.js`ï¼‰
3. ä¸­é—´ä»¶ (`rewrites, redirects` ç­‰)
4. beforeFiles (`next.config.js ä¸­çš„ rewrites`)
5. åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è·¯ç”± (`public/, _next/static/, pages/, app/ ç­‰`)
6. afterFiles (`next.config.js ä¸­çš„ rewrites`)
7. åŠ¨æ€è·¯ç”± (`/blog/[slug]`)
8. fallback ä¸­çš„ (`next.config.js ä¸­çš„ rewrites`)

### ä¸­é—´ä»¶ç›¸å…³é…ç½®é¡¹ï¼š`skipTrailingSlashRedirect`ï¼ˆè·³è¿‡å°¾éƒ¨æ–œæ é‡å®šå‘ï¼‰ å’Œ `skipTrailingSlashRedirect`

#### `skipTrailingSlashRedirect`

> å½“ä½ è®¾ç½® `skipTrailingSlashRedirect` ä¸º true åï¼Œå‡è®¾å†æ¬¡è®¿é—® `/about/`ï¼ŒURL ä¾ç„¶ä¼šæ˜¯` /about/`ã€‚

#### `skipTrailingSlashRedirect`

> è®¾ç½® `skipMiddlewareUrlNormalize` ä¸º true åï¼Œå¯ä»¥è·å–è·¯ç”±åŸå§‹çš„åœ°å€ï¼Œå¸¸ç”¨äºå›½é™…åŒ–åœºæ™¯ä¸­ã€‚

### è¿è¡Œæ—¶æ³¨æ„äº‹é¡¹

> ä½¿ç”¨ Middleware çš„æ—¶å€™è¿˜è¦æ³¨æ„ä¸€ç‚¹ï¼Œé‚£å°±æ˜¯ç›®å‰ Middleware åªæ”¯æŒ `Edge runtime`ï¼Œå¹¶ä¸æ”¯æŒ `Node.js runtime`ã€‚è¿™æ„å‘³ç€å†™ Middleware çš„æ—¶å€™ï¼Œå°½å¯èƒ½ä½¿ç”¨ Web APIï¼Œé¿å…ä½¿ç”¨ Node.js API

### å¤šä¸ªä¸­é—´ä»¶çš„æƒ…å†µ

```ts
import { NextResponse } from "next/server";

// å·¥å…·æ–¹æ³•
function chain(functions, index = 0) {
  const current = functions[index];
  if (current) {
    const next = chain(functions, index + 1);
    return current(next);
  }
  return () => NextResponse.next();
}

// ç¬¬ä¸€ä¸ªä¸­é—´ä»¶
function withMiddleware1(middleware) {
  return async (request) => {
    console.log("middleware1 " + request.url);
    return middleware(request);
  };
}

// ç¬¬äºŒä¸ªä¸­é—´ä»¶
function withMiddleware2(middleware) {
  return async (request) => {
    console.log("middleware2 " + request.url);
    return middleware(request);
  };
}

export default chain([withMiddleware1, withMiddleware2]); // è¿è¡Œé¡ºåºï¼šwithMiddleware1, withMiddleware2

export const config = {
  matcher: "/api/:path*",
};
```

## æœåŠ¡ç«¯ç»„ä»¶å’Œå®¢æˆ·ç«¯ç»„ä»¶

### æœåŠ¡ç«¯ç»„ä»¶

> é»˜è®¤å°±æ˜¯æœåŠ¡ç«¯ç»„ä»¶

**ğŸ”… ä¼˜åŠ¿ ğŸ”…**

1. **æ•°æ®è·å–**ï¼šé€šå¸¸æœåŠ¡ç«¯ç¯å¢ƒï¼ˆç½‘ç»œã€æ€§èƒ½ç­‰ï¼‰æ›´å¥½ï¼Œç¦»æ•°æ®æºæ›´è¿‘ï¼Œåœ¨æœåŠ¡ç«¯è·å–æ•°æ®ä¼šæ›´å¿«ã€‚é€šè¿‡å‡å°‘æ•°æ®åŠ è½½æ—¶é—´ä»¥åŠå®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚æ•°é‡æ¥æé«˜æ€§èƒ½
2. **å®‰å…¨**ï¼šåœ¨æœåŠ¡ç«¯ä¿ç•™æ•æ„Ÿæ•°æ®å’Œé€»è¾‘ï¼Œä¸ç”¨æ‹…å¿ƒæš´éœ²ç»™å®¢æˆ·ç«¯
3. **ç¼“å­˜**ï¼šæœåŠ¡ç«¯æ¸²æŸ“çš„ç»“æœå¯ä»¥åœ¨åç»­çš„è¯·æ±‚ä¸­å¤ç”¨ï¼Œæé«˜æ€§èƒ½
4. **bundle å¤§å°**ï¼šæœåŠ¡ç«¯ç»„ä»¶çš„ä»£ç ä¸ä¼šæ‰“åŒ…åˆ° bundle ä¸­ï¼Œå‡å°‘äº† bundle åŒ…çš„å¤§å°
5. **åˆå§‹é¡µé¢åŠ è½½å’Œ FCP**ï¼šæœåŠ¡ç«¯æ¸²æŸ“ç”Ÿæˆ HTMLï¼Œå¿«é€Ÿå±•ç¤º UI
6. **Streaming**ï¼šæœåŠ¡ç«¯ç»„ä»¶å¯ä»¥å°†æ¸²æŸ“å·¥ä½œæ‹†åˆ†ä¸º chunksï¼Œå¹¶åœ¨å‡†å¤‡å°±ç»ªæ—¶å°†å®ƒä»¬æµå¼ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚ç”¨æˆ·å¯ä»¥æ›´æ—©çœ‹åˆ°é¡µé¢çš„éƒ¨åˆ†å†…å®¹ï¼Œè€Œä¸å¿…ç­‰å¾…æ•´ä¸ªé¡µé¢æ¸²æŸ“å®Œæ¯•

**âš ï¸ é™åˆ¶ âš ï¸**

> ä¸èƒ½ä½¿ç”¨ useState ç®¡ç†çŠ¶æ€ï¼Œä¸èƒ½ä½¿ç”¨æµè§ˆå™¨çš„ API ç­‰ç­‰

### å®¢æˆ·ç«¯ç»„ä»¶

> éœ€è¦åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ ä¸€ä¸ª `"use client"` å£°æ˜

**âš ï¸ æ³¨æ„ âš ï¸**ï¼š"use client"ç”¨äºå£°æ˜æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç»„ä»¶æ¨¡å—ä¹‹é—´çš„è¾¹ç•Œã€‚å½“ä½ åœ¨æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ª "use client"ï¼Œå¯¼å…¥çš„å…¶ä»–æ¨¡å—åŒ…æ‹¬å­ç»„ä»¶ï¼Œéƒ½ä¼šè¢«è§†ä¸ºå®¢æˆ·ç«¯ bundle çš„ä¸€éƒ¨åˆ†ã€‚

**ğŸ”… ä¼˜åŠ¿ ğŸ”…**

1. **äº¤äº’æ€§**ï¼šå®¢æˆ·ç«¯ç»„ä»¶å¯ä»¥ä½¿ç”¨ stateã€effects å’Œäº‹ä»¶ç›‘å¬å™¨ï¼Œæ„å‘³ç€ç”¨æˆ·å¯ä»¥ä¸ä¹‹äº¤äº’
2. **æµè§ˆå™¨ API**ï¼šå®¢æˆ·ç«¯ç»„ä»¶å¯ä»¥ä½¿ç”¨æµè§ˆå™¨ API å¦‚åœ°ç†ä½ç½®ã€localStorage ç­‰

### **æ¸²æŸ“ç¯å¢ƒ**ï¼šæœåŠ¡ç«¯ç»„ä»¶åªä¼šåœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œä½†å®¢æˆ·ç«¯ç»„ä»¶ä¼šåœ¨æœåŠ¡ç«¯æ¸²æŸ“ä¸€æ¬¡ï¼Œç„¶ååœ¨å®¢æˆ·ç«¯æ¸²æŸ“ã€‚

> æœåŠ¡ç«¯ç»„ä»¶è¿è¡Œåœ¨æ„å»ºæ—¶å’ŒæœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯ç»„ä»¶è¿è¡Œåœ¨æ„å»ºæ—¶ã€æœåŠ¡ç«¯ï¼ˆç”Ÿæˆåˆå§‹ HTMLï¼‰å’Œå®¢æˆ·ç«¯ï¼ˆç®¡ç† DOMï¼‰

#### **æœåŠ¡ç«¯ç»„ä»¶å¯ä»¥ç›´æ¥å¯¼å…¥å®¢æˆ·ç«¯ç»„ä»¶ï¼Œä½†å®¢æˆ·ç«¯ç»„ä»¶å¹¶ä¸èƒ½å¯¼å…¥æœåŠ¡ç«¯ç»„ä»¶**

### ç»„ä»¶æ¸²æŸ“åŸç†

åœ¨æœåŠ¡ç«¯ï¼š

Next.js ä½¿ç”¨ React API ç¼–æ’æ¸²æŸ“ï¼Œæ¸²æŸ“å·¥ä½œä¼šæ ¹æ®è·¯ç”±å’Œ Suspense æ‹†åˆ†æˆå¤šä¸ªå—ï¼ˆchunksï¼‰ï¼Œæ¯ä¸ªå—åˆ†ä¸¤æ­¥è¿›è¡Œæ¸²æŸ“ï¼š

1. React å°†æœåŠ¡ç«¯ç»„ä»¶æ¸²æŸ“æˆä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®æ ¼å¼ç§°ä¸º React Server Component Payload (RSC Payload)
2. Next.js ä½¿ç”¨ RSC Payload å’Œå®¢æˆ·ç«¯ç»„ä»¶ä»£ç åœ¨æœåŠ¡ç«¯æ¸²æŸ“ HTML

> RSC payload ä¸­åŒ…å«å¦‚ä¸‹è¿™äº›ä¿¡æ¯ï¼š
>
> 1. æœåŠ¡ç«¯ç»„ä»¶çš„æ¸²æŸ“ç»“æœ
> 2. å®¢æˆ·ç«¯ç»„ä»¶å ä½ç¬¦å’Œå¼•ç”¨æ–‡ä»¶
> 3. ä»æœåŠ¡ç«¯ç»„ä»¶ä¼ ç»™å®¢æˆ·ç«¯ç»„ä»¶çš„æ•°æ®

åœ¨å®¢æˆ·ç«¯ï¼š

1. åŠ è½½æ¸²æŸ“çš„ HTML å¿«é€Ÿå±•ç¤ºä¸€ä¸ªéäº¤äº’ç•Œé¢ï¼ˆNon-interactive UIï¼‰
2. RSC Payload ä¼šè¢«ç”¨äºåè°ƒï¼ˆreconcileï¼‰å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç»„ä»¶æ ‘ï¼Œå¹¶æ›´æ–° DOM
3. JavaScript ä»£ç è¢«ç”¨äºæ°´åˆå®¢æˆ·ç«¯ç»„ä»¶ï¼Œä½¿åº”ç”¨ç¨‹åºå…·æœ‰äº¤äº’æ€§ï¼ˆInteractive UIï¼‰

## æœåŠ¡ç«¯æ¸²æŸ“ç­–ç•¥

### é™æ€æ¸²æŸ“ï¼ˆStatic Renderingï¼‰

> **é»˜è®¤æ¸²æŸ“ç­–ç•¥ï¼Œè·¯ç”±åœ¨æ„å»ºæ—¶æ¸²æŸ“ï¼Œæˆ–è€…åœ¨é‡æ–°éªŒè¯ååå°æ¸²æŸ“**ï¼Œå…¶ç»“æœä¼šè¢«ç¼“å­˜å¹¶ä¸”å¯ä»¥æ¨é€åˆ° CDNã€‚é€‚ç”¨äºæœªé’ˆå¯¹ç”¨æˆ·ä¸ªæ€§åŒ–ä¸”æ•°æ®å·²çŸ¥çš„æƒ…å†µï¼Œæ¯”å¦‚é™æ€åšå®¢æ–‡ç« ã€äº§å“ä»‹ç»é¡µé¢ç­‰ã€‚

### åŠ¨æ€æ¸²æŸ“ï¼ˆDynamic Renderingï¼‰

> åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä½¿ç”¨äº†åŠ¨æ€å‡½æ•°ï¼ˆDynamic functionsï¼‰æˆ–è€…æœªç¼“å­˜çš„æ•°æ®è¯·æ±‚ï¼ˆuncached data requestï¼‰ï¼ŒNext.js å°±ä¼šåˆ‡æ¢ä¸ºåŠ¨æ€æ¸²æŸ“

#### ä½¿ç”¨åŠ¨æ€å‡½æ•°ï¼ˆDynamic functionsï¼‰

> **åŠ¨æ€å‡½æ•°æŒ‡çš„æ˜¯è·å–åªæœ‰åœ¨è¯·æ±‚æ—¶æ‰èƒ½å¾—åˆ°ä¿¡æ¯ï¼ˆå¦‚ cookieã€è¯·æ±‚å¤´ã€URL å‚æ•°ï¼‰çš„å‡½æ•°ã€‚**

åœ¨ Next.js ä¸­è¿™äº›åŠ¨æ€å‡½æ•°æ˜¯ï¼š

1. cookies() å’Œ headers() ï¼šè·å– cookie å’Œ header
2. searchParamsï¼šé¡µé¢æŸ¥è¯¢å‚æ•°

#### ä½¿ç”¨æœªç¼“å­˜çš„æ•°æ®è¯·æ±‚ï¼ˆuncached data requestï¼‰

åœ¨ Next.js ä¸­ï¼Œfetch è¯·æ±‚çš„ç»“æœé»˜è®¤ä¼šè¢«ç¼“å­˜ï¼Œä½†ä½ å¯ä»¥è®¾ç½®é€€å‡ºç¼“å­˜ï¼Œä¸€æ—¦ä½ è®¾ç½®äº†é€€å‡ºç¼“å­˜ï¼Œå°±æ„å‘³ç€ä½¿ç”¨äº†æœªç¼“å­˜çš„æ•°æ®è¯·æ±‚ï¼ˆuncached data requestï¼‰ï¼Œä¼šå¯¼è‡´è·¯ç”±è¿›å…¥åŠ¨æ€æ¸²æŸ“ï¼Œå¦‚ï¼š

1. fetch è¯·æ±‚æ·»åŠ äº† `cache: 'no-store'` é€‰é¡¹
2. fetch è¯·æ±‚æ·»åŠ äº† `revalidate: 0` é€‰é¡¹
3. fetch è¯·æ±‚åœ¨è·¯ç”±å¤„ç†ç¨‹åºä¸­å¹¶ä½¿ç”¨äº† POST æ–¹æ³•
4. åœ¨ headers æˆ– cookies æ–¹æ³•ä¹‹åä½¿ç”¨ fetch è¯·æ±‚
5. é…ç½®äº†è·¯ç”±æ®µé€‰é¡¹ `const dynamic = 'force-dynamic'`
6. é…ç½®äº†è·¯ç”±æ®µé€‰é¡¹ `fetchCache` ï¼Œé»˜è®¤ä¼šè·³è¿‡ç¼“å­˜ ([ä¾‹å­](./app/cat/page.tsx))
7. fetch è¯·æ±‚ä½¿ç”¨äº† `Authorization` æˆ–è€… `Cookie` è¯·æ±‚å¤´ï¼Œå¹¶ä¸”åœ¨ç»„ä»¶æ ‘ä¸­å…¶ä¸Šæ–¹è¿˜æœ‰ä¸€ä¸ªæœªç¼“å­˜çš„è¯·æ±‚

### `Streaming`

> ä½¿ç”¨ `loading.tsx` æˆ–è€… `React Suspense` ç»„ä»¶ä¼šå¼€å¯ `Streaming`

## Next.js æ•°æ®è·å–ã€ç¼“å­˜ä¸é‡æ–°éªŒè¯

> Next.js ä¼˜å…ˆæ¨èä½¿ç”¨åŸç”Ÿçš„ fetch æ–¹æ³•ï¼Œå› ä¸º Next.js æ‹“å±•äº†åŸç”Ÿçš„ fetch æ–¹æ³•ï¼Œä¸ºå…¶æ·»åŠ äº†ç¼“å­˜å’Œæ›´æ–°ç¼“å­˜(é‡æ–°éªŒè¯)çš„æœºåˆ¶

### é»˜è®¤ç¼“å­˜

> é»˜è®¤æƒ…å†µä¸‹ï¼ŒNext.js ä¼šè‡ªåŠ¨ç¼“å­˜æœåŠ¡ç«¯ fetch è¯·æ±‚çš„è¿”å›å€¼ï¼ˆèƒŒåç”¨çš„æ˜¯æ•°æ®ç¼“å­˜ï¼ˆData Cacheï¼‰ï¼‰ã€‚

```ts
// fetch çš„ cache é€‰é¡¹ç”¨äºæ§åˆ¶è¯¥è¯·æ±‚çš„ç¼“å­˜è¡Œä¸º
// é»˜è®¤å°±æ˜¯ 'force-cache', å¹³æ—¶å†™çš„æ—¶å€™å¯ä»¥çœç•¥
fetch("https://...", { cache: "force-cache" });
```

ä½†è¿™äº›æƒ…å†µé»˜è®¤ä¸ä¼šè‡ªåŠ¨ç¼“å­˜ï¼š

1. åœ¨ Server Action ä¸­ä½¿ç”¨çš„æ—¶å€™
2. åœ¨å®šä¹‰äº†é GET æ–¹æ³•çš„è·¯ç”±å¤„ç†ç¨‹åºä¸­ä½¿ç”¨çš„æ—¶å€™

> **åœ¨æœåŠ¡ç«¯ç»„ä»¶å’Œåªæœ‰ GET æ–¹æ³•çš„è·¯ç”±å¤„ç†ç¨‹åºä¸­ä½¿ç”¨ fetchï¼Œè¿”å›ç»“æœä¼šè‡ªåŠ¨ç¼“å­˜ã€‚**

#### logging é…ç½®é¡¹

```ts
// next.config.mjs
const nextConfig = {
  logging: {
    fetches: {
      fullUrl: true,
    },
  },
};

export default nextConfig;
```

#### æœåŠ¡ç«¯ç»„ä»¶

> åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œå¯ä»¥ä½¿ç”¨æµè§ˆå™¨çš„ç¡¬åˆ·æ–°æ¸…é™¤ç¼“å­˜ï¼Œæ­¤æ—¶æ•°æ®ä¼šå‘ç”Ÿæ›´æ”¹ï¼ˆcache: SKIPï¼‰ã€‚æ™®é€šåˆ·æ–°æ—¶å› ä¸ºä¼šå‘½ä¸­ç¼“å­˜ï¼ˆcache: HITï¼‰ï¼Œæ•°æ®ä¼šä¿æŒä¸å˜ã€‚
> è€Œåœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œ fetch è¯·æ±‚çš„è¿”å›ç»“æœè¢«ç¼“å­˜äº†ï¼Œæ— è®ºæ˜¯å¦ç¡¬åˆ·æ–°ï¼Œå›¾ç‰‡æ•°æ®éƒ½ä¼šä¿æŒä¸å˜ã€‚

#### è·¯ç”±å¤„ç†ç¨‹åº GET è¯·æ±‚

> åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œæµè§ˆå™¨ç¡¬åˆ·æ–°çš„æ—¶å€™ä¼šè·³è¿‡ç¼“å­˜ï¼Œæ™®é€šåˆ·æ–°çš„æ—¶å€™åˆ™ä¼šå‘½ä¸­ç¼“å­˜ã€‚
> è€Œåœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œfetch è¯·æ±‚çš„è¿”å›ç»“æœè¢«ç¼“å­˜äº†ï¼Œæ— è®ºæ˜¯å¦ç¡¬åˆ·æ–°ï¼Œæ¥å£æ•°æ®éƒ½ä¼šä¿æŒä¸å˜ã€‚

```ts
// app/api/cache/route.ts
export async function GET() {
  const res = await fetch("https://dog.ceo/api/breeds/image/random");

  const data = await res.json();
  return Response.json({ data });
}
```

### é‡æ–°éªŒè¯

> åœ¨ Next.js ä¸­ï¼Œæ¸…é™¤æ•°æ®ç¼“å­˜å¹¶é‡æ–°è·å–æœ€æ–°æ•°æ®çš„è¿‡ç¨‹å°±å«åšé‡æ–°éªŒè¯ï¼ˆRevalidationï¼‰ã€‚

#### åŸºäºæ—¶é—´çš„é‡æ–°éªŒè¯ï¼ˆTime-based revalidationï¼‰

> å³ç»è¿‡ä¸€å®šæ—¶é—´å¹¶æœ‰æ–°è¯·æ±‚äº§ç”Ÿåé‡æ–°éªŒè¯æ•°æ®ï¼Œé€‚ç”¨äºä¸ç»å¸¸æ›´æ”¹ä¸”æ–°é²œåº¦ä¸é‚£ä¹ˆé‡è¦çš„æ•°æ®ã€‚

```ts
// â‘  -> next.revalidate
fetch("https://...", { next: { revalidate: 3600 } });

// â‘¡ -> layout.jsx | page.jsx | route.js
export const revalidate = 3600;
```

#### æŒ‰éœ€é‡æ–°éªŒè¯ï¼ˆOn-demand revalidationï¼‰

> æ ¹æ®äº‹ä»¶æ‰‹åŠ¨é‡æ–°éªŒè¯æ•°æ®ã€‚æŒ‰éœ€é‡æ–°éªŒè¯åˆå¯ä»¥ä½¿ç”¨åŸºäºæ ‡ç­¾ï¼ˆtag-basedï¼‰å’ŒåŸºäºè·¯å¾„ï¼ˆpath-basedï¼‰ä¸¤ç§æ–¹æ³•é‡æ–°éªŒè¯æ•°æ®ã€‚é€‚ç”¨äºéœ€è¦å°½å¿«å±•ç¤ºæœ€æ–°æ•°æ®çš„åœºæ™¯ã€‚

**ä½¿ç”¨æŒ‰éœ€é‡æ–°éªŒè¯ï¼Œåœ¨è·¯ç”±å¤„ç†ç¨‹åºæˆ–è€… Server Action ä¸­é€šè¿‡è·¯å¾„ï¼ˆ revalidatePathï¼‰ æˆ–ç¼“å­˜æ ‡ç­¾ revalidateTag å®ç°ã€‚**

## ç¼“å­˜æœºåˆ¶

Next.js ä¸­æœ‰å››ç§ç¼“å­˜æœºåˆ¶ï¼š

| æœºåˆ¶                             | ç¼“å­˜å†…å®¹            | å­˜å‚¨åœ°æ–¹ | ç›®çš„                      | æœŸé—´               |
| -------------------------------- | ------------------- | -------- | ------------------------- | ------------------ |
| è¯·æ±‚è®°å¿†ï¼ˆRequest Memoizationï¼‰  | å‡½æ•°è¿”å›å€¼          | æœåŠ¡ç«¯   | åœ¨ React ç»„ä»¶æ ‘ä¸­å¤ç”¨æ•°æ® | æ¯ä¸ªè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸ |
| æ•°æ®ç¼“å­˜ï¼ˆData Cache ï¼‰          | æ•°æ®                | æœåŠ¡ç«¯   | è·¨ç”¨æˆ·è¯·æ±‚å’Œéƒ¨ç½²å¤ç”¨æ•°æ®  | æŒä¹…ï¼ˆå¯é‡æ–°éªŒè¯ï¼‰ |
| å®Œæ•´è·¯ç”±ç¼“å­˜ï¼ˆFull Route Cacheï¼‰ | HTML å’Œ RSC payload | æœåŠ¡ç«¯   | é™ä½æ¸²æŸ“æˆæœ¬ã€æé«˜æ€§èƒ½    | æŒä¹…ï¼ˆå¯é‡æ–°éªŒè¯ï¼‰ |
| è·¯ç”±ç¼“å­˜ï¼ˆRouter Cacheï¼‰         | RSC payload         | å®¢æˆ·ç«¯   | å‡å°‘å¯¼èˆªæ—¶çš„æœåŠ¡ç«¯è¯·æ±‚    | ç”¨æˆ·ä¼šè¯æˆ–åŸºäºæ—¶é—´ |

### è¯·æ±‚è®°å¿†ï¼ˆRequest Memoizationï¼‰

> React æ‹“å±•äº† fetch APIï¼Œå½“æœ‰ç›¸åŒçš„ URL å’Œå‚æ•°çš„æ—¶å€™ï¼ŒReact ä¼šè‡ªåŠ¨å°†è¯·æ±‚ç»“æœç¼“å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³æ—¶ä½ åœ¨ç»„ä»¶æ ‘ä¸­çš„å¤šä¸ªä½ç½®è¯·æ±‚ä¸€ä»½ç›¸åŒçš„æ•°æ®ï¼Œä½†æ•°æ®è·å–åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚

**âš ï¸ æ³¨æ„ âš ï¸**

1. **è¯·æ±‚è®°å¿†æ˜¯ React çš„ç‰¹æ€§ï¼Œå¹¶é Next.js çš„ç‰¹æ€§**ã€‚ React å’Œ Next.js éƒ½åšäº†è¯·æ±‚ç¼“å­˜ï¼ŒReact çš„æ–¹æ¡ˆå«åšâ€œè¯·æ±‚è®°å¿†â€ï¼ŒNext.js çš„æ–¹æ¡ˆå«åšâ€œæ•°æ®ç¼“å­˜â€ï¼Œä¸¤è€…æœ‰å¾ˆå¤šä¸åŒ
2. **è¯·æ±‚è®°å¿†åªé€‚åˆç”¨äºç”¨ GET æ–¹æ³•çš„ fetch è¯·æ±‚**
3. **è¯·æ±‚è®°å¿†åªåº”ç”¨äº React ç»„ä»¶æ ‘**ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ åœ¨ `generateMetadata`ã€`generateStaticParams`ã€å¸ƒå±€ã€é¡µé¢å’Œå…¶ä»–æœåŠ¡ç«¯ç»„ä»¶ä¸­ä½¿ç”¨ fetch ä¼šè§¦å‘è¯·æ±‚è®°å¿†ï¼Œä½†æ˜¯åœ¨è·¯ç”±å¤„ç†ç¨‹åºä¸­ä½¿ç”¨åˆ™ä¸ä¼šè§¦å‘ï¼Œå› ä¸ºè¿™å°±ä¸åœ¨ React ç»„ä»¶æ ‘ä¸­äº†

### æ•°æ®ç¼“å­˜ï¼ˆData Cacheï¼‰

Next.js æœ‰è‡ªå·±çš„æ•°æ®ç¼“å­˜æ–¹æ¡ˆï¼Œå¯ä»¥è·¨æœåŠ¡ç«¯è¯·æ±‚å’Œæ„å»ºéƒ¨ç½²å­˜å‚¨æ•°æ®ã€‚ä¹‹æ‰€ä»¥èƒ½å¤Ÿå®ç°ï¼Œæ˜¯å› ä¸º Next.js æ‹“å±•äº† fetch APIï¼Œåœ¨ Next.js ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½å¯ä»¥è®¾ç½®è‡ªå·±çš„ç¼“å­˜æ–¹å¼ã€‚

ä¸è¿‡ä¸ React çš„è¯·æ±‚è®°å¿†ä¸åŒçš„æ˜¯ï¼Œè¯·æ±‚è®°å¿†å› ä¸ºåªç”¨äºç»„ä»¶æ ‘æ¸²æŸ“çš„æ—¶å€™ï¼Œæ‰€ä»¥ä¸ç”¨è€ƒè™‘æ•°æ®ç¼“å­˜æ›´æ–°çš„æƒ…å†µï¼Œä½† Next.js çš„æ•°æ®ç¼“å­˜æ–¹æ¡ˆæ›´ä¸ºæŒä¹…ï¼Œåˆ™éœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ fetch çš„æ•°æ®è¯·æ±‚éƒ½ä¼šè¢«ç¼“å­˜ï¼Œè¿™ä¸ªç¼“å­˜æ˜¯æŒä¹…çš„ï¼Œå®ƒä¸ä¼šè‡ªåŠ¨è¢«é‡ç½®ã€‚ä½ å¯ä»¥ä½¿ç”¨ fetch çš„ cache å’Œ `next.revalidate` é€‰é¡¹æ¥é…ç½®ç¼“å­˜è¡Œä¸ºï¼š

### **è¯·æ±‚è®°å¿†å’Œæ•°æ®ç¼“å­˜çš„å¯¹æ¯”æ€»ç»“**

- **è¯·æ±‚è®°å¿†**æ˜¯ `React` çš„æ•°æ®ç¼“å­˜æ–¹æ¡ˆï¼Œå®ƒåªæŒç»­åœ¨ç»„ä»¶æ ‘æ¸²æŸ“æœŸé—´ï¼Œç›®çš„æ˜¯ä¸ºäº†é¿å…ç»„ä»¶æ ‘æ¸²æŸ“çš„æ—¶å€™å¤šæ¬¡è¯·æ±‚åŒä¸€æ•°æ®é€ æˆçš„æ€§èƒ½å½±å“ã€‚
- **æ•°æ®ç¼“å­˜**æ˜¯ `Next.js` çš„æ•°æ®ç¼“å­˜æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥è·¨éƒ¨ç½²å’Œè¯·æ±‚ç¼“å­˜ï¼Œç¼“å­˜æ•°æ®ä¸ä¼šå¤±æ•ˆï¼Œé™¤éé‡æ–°éªŒè¯æˆ–è€…ä¸»åŠ¨é€€å‡ºã€‚ç›®çš„åœ¨äºä¼˜åŒ–åº”ç”¨æ€§èƒ½ã€‚
- å®é™…é¡¹ç›®å¼€å‘çš„æ—¶å€™ï¼Œè¯·æ±‚è®°å¿†å’Œæ•°æ®ç¼“å­˜å¾€å¾€åŒæ—¶å­˜åœ¨ï¼Œå…±åŒä½œç”¨ã€‚

### å®Œæ•´è·¯ç”±ç¼“å­˜ï¼ˆFull Route Cacheï¼‰

#### å·¥ä½œåŸç†

> Next.js åœ¨æ„å»ºçš„æ—¶å€™ä¼šè‡ªåŠ¨æ¸²æŸ“å’Œç¼“å­˜è·¯ç”±ï¼Œè¿™æ ·å½“è®¿é—®è·¯ç”±çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ç¼“å­˜ä¸­çš„è·¯ç”±è€Œä¸ç”¨ä»é›¶å¼€å§‹åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œä»è€ŒåŠ å¿«é¡µé¢åŠ è½½é€Ÿåº¦ã€‚

Next.js ä½¿ç”¨ React çš„ API æ¥ç¼–æ’æ¸²æŸ“ã€‚å½“æ¸²æŸ“çš„æ—¶å€™ï¼Œæ¸²æŸ“å·¥ä½œä¼šæ ¹æ®è·¯ç”±å’Œ Suspense æ‹†åˆ†æˆå¤šä¸ª chunkï¼Œæ¯ä¸ª chunk åˆ†ä¸ºä¸¤æ­¥è¿›è¡Œæ¸²æŸ“ï¼š

1. React ä¼šå°†æœåŠ¡ç«¯ç»„ä»¶æ¸²æŸ“æˆä¸€ç§ç‰¹æ®Šçš„æ•°æ®æ ¼å¼ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º `React Server Component Payload`ï¼Œç®€å†™ä¸º `RSC payload`

   > RSC payload ä»£ç è‚¯å®šæ˜¯ä¸èƒ½ç›´æ¥æ‰§è¡Œçš„ï¼Œå®ƒåŒ…å«çš„æ›´å¤šæ˜¯ä¿¡æ¯ï¼š
   >
   > - æœåŠ¡ç«¯ç»„ä»¶çš„æ¸²æŸ“ç»“æœ
   > - å®¢æˆ·ç«¯ç»„ä»¶çš„å ä½å’Œå¼•ç”¨æ–‡ä»¶
   > - ä»æœåŠ¡ç«¯ç»„ä»¶ä¼ ç»™å®¢æˆ·ç«¯ç»„ä»¶çš„æ•°æ®

2. Next.js ä¼šç”¨ RSC payload å’Œå®¢æˆ·ç«¯ç»„ä»¶ä»£ç åœ¨æœåŠ¡ç«¯æ¸²æŸ“ HTML

#### å®Œæ•´è·¯ç”±ç¼“å­˜é»˜è®¤æ˜¯æŒä¹…çš„ï¼Œè¿™æ„å‘³ç€å¯ä»¥è·¨ç”¨æˆ·è¯·æ±‚å¤ç”¨ã€‚

#### å¤±æ•ˆæ–¹å¼

é€€å‡ºå®Œæ•´è·¯ç”±ç¼“å­˜çš„æ–¹å¼å°±æ˜¯å°†å…¶æ”¹ä¸ºåŠ¨æ€æ¸²æŸ“ï¼š

1. ä½¿ç”¨åŠ¨æ€å‡½æ•°ï¼šä½¿ç”¨åŠ¨æ€å‡½æ•°åä¼šæ”¹ä¸ºåŠ¨æ€æ¸²æŸ“ï¼Œæ­¤æ—¶æ•°æ®ç¼“å­˜ä¾ç„¶å¯ä»¥ç”¨
2. ä½¿ç”¨è·¯ç”±æ®µé…ç½®é¡¹ï¼š`dynamic = 'force-dynamic'`æˆ– `revalidate = 0` è¿™ä¼šè·³è¿‡å®Œæ•´è·¯ç”±ç¼“å­˜å’Œæ•°æ®ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶éƒ½ä¼šé‡æ–°è·å–æ•°æ®å¹¶æ¸²æŸ“ç»„ä»¶ã€‚æ­¤æ—¶è·¯ç”±ç¼“å­˜ä¾ç„¶å¯ä»¥ç”¨ï¼Œæ¯•ç«Ÿå®ƒæ˜¯å®¢æˆ·ç«¯ç¼“å­˜
3. é€€å‡ºæ•°æ®ç¼“å­˜ï¼šå¦‚æœè·¯ç”±ä¸­æœ‰ä¸€ä¸ª fetch è¯·æ±‚é€€å‡ºäº†ç¼“å­˜ï¼Œåˆ™ä¼šé€€å‡ºå®Œæ•´è·¯ç”±ç¼“å­˜ã€‚è¿™ä¸ªç‰¹å®šçš„ fetch è¯·æ±‚ä¼šåœ¨æ¯æ¬¡è¯·æ±‚æ—¶é‡æ–°è·å–ï¼Œå…¶ä»– fetch è¯·æ±‚ä¾ç„¶ä¼šä½¿ç”¨æ•°æ®ç¼“å­˜ã€‚Next.js å…è®¸è¿™ç§ç¼“å­˜å’Œæœªç¼“å­˜æ•°æ®çš„æ··åˆ

**ç®€å•æ¥è¯´ï¼Œå®Œæ•´è·¯ç”±ç¼“å­˜åªé€‚ç”¨äºé™æ€æ¸²æŸ“ï¼Œåœ¨æœåŠ¡ç«¯ä¿ç•™é™æ€æ¸²æŸ“çš„äº§ç‰© RSC Payload å’Œ HTMLã€‚**

### è·¯ç”±ç¼“å­˜ï¼ˆRouter Cacheï¼‰

#### å·¥ä½œåŸç†

> Next.js æœ‰ä¸€ä¸ªå­˜æ”¾åœ¨å†…å­˜ä¸­çš„å®¢æˆ·ç«¯ç¼“å­˜ï¼Œå®ƒä¼šåœ¨ç”¨æˆ·ä¼šè¯æœŸé—´æŒ‰è·¯ç”±æ®µå­˜å‚¨ RSC Payloadã€‚è¿™å°±æ˜¯è·¯ç”±ç¼“å­˜ã€‚

#### ç”Ÿå‘½å‘¨æœŸ

è·¯ç”±ç¼“å­˜å­˜æ”¾åœ¨æµè§ˆå™¨çš„ä¸´æ—¶ç¼“å­˜ä¸­ï¼Œæœ‰ä¸¤ä¸ªå› ç´ å†³å®šäº†è·¯ç”±ç¼“å­˜çš„æŒç»­æ—¶é—´ï¼š

- Sessionï¼Œç¼“å­˜åœ¨å¯¼èˆªæ—¶æŒç»­å­˜åœ¨ï¼Œå½“é¡µé¢åˆ·æ–°çš„æ—¶å€™ä¼šè¢«æ¸…é™¤
- è‡ªåŠ¨å¤±æ•ˆæœŸï¼šå•ä¸ªè·¯ç”±æ®µä¼šåœ¨ç‰¹å®šæ—¶é•¿åè‡ªåŠ¨å¤±æ•ˆ
  - å¦‚æœè·¯ç”±æ˜¯é™æ€æ¸²æŸ“ï¼ŒæŒç»­ 5 åˆ†é’Ÿ
  - å¦‚æœè·¯ç”±æ˜¯åŠ¨æ€æ¸²æŸ“ï¼ŒæŒç»­ 30s

#### å¤±æ•ˆæ–¹å¼

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®©è·¯ç”±ç¼“å­˜å¤±æ•ˆï¼š

- åœ¨ `Server Action` ä¸­
  - é€šè¿‡ `revalidatePath` æˆ– `revalidateTag` é‡æ–°éªŒè¯æ•°æ®
  - ä½¿ç”¨ `cookies.set` æˆ–è€… `cookies.delete` ä¼šä½¿è·¯ç”±ç¼“å­˜å¤±æ•ˆï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢ä½¿ç”¨ cookie çš„è·¯ç”±è¿‡æ—¶ï¼ˆå¦‚èº«ä»½éªŒè¯ï¼‰
- è°ƒç”¨ `router.refresh` ä¼šä½¿è·¯ç”±ç¼“å­˜å¤±æ•ˆå¹¶å‘èµ·ä¸€ä¸ªé‡æ–°è·å–å½“å‰è·¯ç”±çš„è¯·æ±‚

**æ— æ³•é€€å‡ºè·¯ç”±ç¼“å­˜ã€‚ä½ å¯ä»¥é€šè¿‡ç»™ <Link> ç»„ä»¶çš„ prefetch ä¼ é€’ false æ¥é€€å‡ºé¢„è·å–ï¼Œä½†ä¾ç„¶ä¼šä¸´æ—¶å­˜å‚¨è·¯ç”±æ®µ 30sï¼Œè¿™æ˜¯ä¸ºäº†å®ç°åµŒå¥—è·¯ç”±æ®µä¹‹é—´çš„å³æ—¶å¯¼èˆª**

### æ€»ç»“

è·¯ç”±ç¼“å­˜å’Œå®Œæ•´è·¯ç”±ç¼“å­˜çš„åŒºåˆ«ï¼š

1. **è·¯ç”±ç¼“å­˜**å‘ç”Ÿåœ¨ç”¨æˆ·è®¿é—®æœŸé—´ï¼Œå°† RSC Payload æš‚æ—¶å­˜å‚¨åœ¨**æµè§ˆå™¨**ï¼Œå¯¼èˆªæœŸé—´éƒ½ä¼šæŒç»­å­˜åœ¨ï¼Œé¡µé¢åˆ·æ–°çš„æ—¶å€™ä¼šè¢«æ¸…é™¤ã€‚è€Œ**å®Œæ•´è·¯ç”±ç¼“å­˜**åˆ™ä¼šæŒä¹…çš„å°† RSC Payload å’Œ HTML ç¼“å­˜åœ¨**æœåŠ¡å™¨**ä¸Š
2. å®Œæ•´è·¯ç”±ç¼“å­˜ä»…ç¼“å­˜é™æ€æ¸²æŸ“çš„è·¯ç”±ï¼Œè·¯ç”±ç¼“å­˜å¯ä»¥åº”ç”¨äºé™æ€å’ŒåŠ¨æ€æ¸²æŸ“çš„è·¯ç”±

## Server Actions

> **Server Actions æ˜¯æŒ‡åœ¨æœåŠ¡ç«¯æ‰§è¡Œçš„å¼‚æ­¥å‡½æ•°ï¼Œå®ƒä»¬å¯ä»¥åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç»„ä»¶ä¸­ä½¿ç”¨ï¼Œä»¥å¤„ç† Next.js åº”ç”¨ä¸­çš„æ•°æ®æäº¤å’Œæ›´æ”¹ã€‚**

### åŸºæœ¬ç”¨æ³•

å®šä¹‰ä¸€ä¸ª Server Action éœ€è¦ä½¿ç”¨ React çš„ "use server" æŒ‡ä»¤ã€‚æŒ‰æŒ‡ä»¤çš„å®šä¹‰ä½ç½®åˆ†ä¸ºä¸¤ç§ç”¨æ³•ï¼š

1. å°† "use server" æ”¾åˆ°ä¸€ä¸ª async å‡½æ•°çš„é¡¶éƒ¨è¡¨ç¤ºè¯¥å‡½æ•°ä¸º Server Actionï¼ˆå‡½æ•°çº§åˆ«ï¼‰
2. å°† "use server" æ”¾åˆ°ä¸€ä¸ªå•ç‹¬æ–‡ä»¶çš„é¡¶éƒ¨è¡¨ç¤ºè¯¥æ–‡ä»¶å¯¼å‡ºçš„æ‰€æœ‰å‡½æ•°éƒ½æ˜¯ Server Actionsï¼ˆæ¨¡å—çº§åˆ«ï¼‰

Server Actions å¯ä»¥åœ¨æœåŠ¡ç«¯ç»„ä»¶ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨å®¢æˆ·ç«¯ç»„ä»¶ä½¿ç”¨ã€‚

### åŸºæœ¬åŸç†

1. Server Actions èƒŒåä½¿ç”¨çš„æ˜¯ POST è¯·æ±‚æ–¹æ³•ï¼Œè¯·æ±‚å½“å‰é¡µé¢åœ°å€ï¼Œæ ¹æ® $ACTION_ID åŒºåˆ†
2. Server Actions ä¸ Next.js çš„ç¼“å­˜å’Œé‡æ–°éªŒè¯æ¶æ„é›†æˆã€‚è°ƒç”¨ Action æ—¶ï¼ŒNext.js å¯ä»¥ä¸€æ¬¡æ€§è¿”å›æ›´æ–°çš„ UI å’Œæ–°æ•°æ®

### Server Actions çš„å¥½å¤„

1. ä»£ç æ›´ç®€æ´ã€‚ä½ ä¹Ÿä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºæ¥å£ï¼Œè€Œä¸” Server Actions æ˜¯å‡½æ•°ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥åœ¨åº”ç”¨ç¨‹åºçš„ä»»æ„ä½ç½®ä¸­å¤ç”¨ã€‚
2. å½“ç»“åˆ form ä½¿ç”¨çš„æ—¶å€™ï¼Œæ”¯æŒæ¸è¿›å¼å¢å¼ºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿ç¦ç”¨ JavaScriptï¼Œè¡¨å•ä¹Ÿå¯ä»¥æ­£å¸¸æäº¤

> ä½¿ç”¨ Server Actions ç¦ç”¨å’Œä¸ç¦ç”¨ JS çš„å·®åˆ«æ˜¯ï¼Œä¸ç¦ç”¨çš„æ—¶å€™æäº¤è¡¨å•ï¼Œé¡µé¢ä¸ä¼šåˆ·æ–°ã€‚ç¦ç”¨çš„æ—¶å€™æäº¤è¡¨å•é¡µé¢ä¼šåˆ·æ–°

### Server Actions çš„æ³¨æ„è¦ç‚¹

1. Server Actions çš„å‚æ•°å’Œè¿”å›å€¼éƒ½å¿…é¡»æ˜¯**å¯åºåˆ—åŒ–**çš„ï¼Œç®€å•çš„è¯´ï¼ŒJSON.stringfiy è¿™ä¸ªå€¼ä¸å‡ºé”™
2. Server Actions ä¼šç»§æ‰¿ä½¿ç”¨çš„é¡µé¢æˆ–è€…å¸ƒå±€çš„è¿è¡Œæ—¶å’Œè·¯ç”±æ®µé…ç½®é¡¹ï¼ŒåŒ…æ‹¬åƒ maxDuration ç­‰å­—æ®µ

### Server Actions å¤„ç†è¡¨å•æäº¤æ—¶å¸¸æ­é…ä½¿ç”¨çš„ä¸€äº› API

#### useFormStatusï¼šç”¨äºè¿”å›è¡¨å•æäº¤çš„çŠ¶æ€ä¿¡æ¯

#### useFormStateï¼šæ ¹æ®è¡¨å• action çš„ç»“æœæ›´æ–°çŠ¶æ€

[ä¾‹å­](app/todo/AddToDoForm.tsx)

**æ³¨æ„**ï¼šå½“ä½¿ç”¨ useFormState çš„æ—¶å€™ï¼Œå¯¹åº” Server Action å‡½æ•°çš„å‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ prevStateï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ formDataã€‚å½“ä½¿ç”¨ useFormStatus çš„æ—¶å€™ï¼Œè¦å†™åœ¨ form ä¸‹çš„å•ç‹¬çš„ç»„ä»¶ä¸­

### Server Actions æ³¨æ„è¦ç‚¹

#### è·å–æäº¤çš„æ•°æ®

å¦‚æœä½¿ç”¨ form action è¿™ç§æœ€åŸºæœ¬çš„å½¢å¼ï¼ŒServer Action å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ formData

```tsx
export default function Page() {
  async function createInvoice(formData) {
    "use server";

    const rawFormData = {
      customerId: formData.get("customerId"),
    };

    // mutate data
    // revalidate cache
  }

  return <form action={createInvoice}>...</form>;
}
```

å¦‚æœä½¿ç”¨ form action + useFormState è¿™ç§å½¢å¼ï¼ŒServer Actions å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ prevStateï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ formDataï¼š

```tsx
"use client";

import { useFormState } from "react-dom";

export default function Home() {
  async function createTodo(prevState, formData) {
    return prevState.concat(formData.get("todo"));
  }

  const [state, formAction] = useFormState(createTodo, []);

  return (
    <form action={formAction}>
      <input type="text" name="todo" />
      <button type="submit">Submit</button>
      <p>{state.join(",")}</p>
    </form>
  );
}
```

#### è¿›è¡Œæ•°æ®æ ¡éªŒå’Œé”™è¯¯å¤„ç†

**Next.js æ¨èåŸºæœ¬çš„è¡¨å•éªŒè¯ä½¿ç”¨ HTML å…ƒç´ è‡ªå¸¦çš„éªŒè¯å¦‚ requiredã€type="email"ç­‰ã€‚**

å¯¹äºæ›´é«˜é˜¶çš„æœåŠ¡ç«¯æ•°æ®éªŒè¯ï¼Œå¯ä»¥ä½¿ç”¨ zod è¿™æ ·çš„ schema éªŒè¯åº“æ¥éªŒè¯è¡¨å•æ•°æ®çš„ç»“æ„

#### é‡æ–°éªŒè¯æ•°æ®

**Server Action ä¿®æ”¹æ•°æ®åï¼Œä¸€å®šè¦æ³¨æ„é‡æ–°éªŒè¯æ•°æ®ï¼Œå¦åˆ™æ•°æ®ä¸ä¼šåŠæ—¶æ›´æ–°ã€‚**

> `revalidatePath` æˆ– `revalidateTag`

#### é”™è¯¯å¤„ç†

> æ³¨æ„è¿”å›é”™è¯¯ä¿¡æ¯æˆ–æŠ›å‡ºé”™è¯¯ä¿¡æ¯ï¼š`try-cattch` æˆ– `error.tsx`

### ä¹è§‚æ›´æ–° useOptimistic

> æ‰€è°“ä¹è§‚æ›´æ–°ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå½“ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªç‚¹èµæŒ‰é’®çš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„åšæ³•æ˜¯ç­‰å¾…æ¥å£è¿”å›æˆåŠŸæ—¶å†æ›´æ–° UIã€‚ä¹è§‚æ›´æ–°æ˜¯å…ˆæ›´æ–° UIï¼ŒåŒæ—¶å‘é€æ•°æ®è¯·æ±‚ï¼Œè‡³äºæ•°æ®è¯·æ±‚åçš„é”™è¯¯å¤„ç†ï¼Œåˆ™æ ¹æ®è‡ªå·±çš„éœ€è¦è‡ªå®šä¹‰å®ç°ã€‚

[ä¾‹å­](app/todo/optimisticForm/page.tsx)

### Server Actions å¸¸è§é—®é¢˜

#### å¤„ç† cookie

```ts
"use server";

import { cookies } from "next/headers";

export async function exampleAction() {
  // Get cookie
  const value = cookies().get("name")?.value;

  // Set cookie
  cookies().set("name", "Delba");

  // Delete cookie
  cookies().delete("name");
}
```

#### é‡å®šå‘

```ts
"use server";

import { redirect } from "next/navigation";
import { revalidateTag } from "next/cache";

export async function createPost(id) {
  try {
    // ...
  } catch (error) {
    // ...
  }

  revalidateTag("todo"); // Update cached todo
  redirect(`/todo/${id}`); // Navigate to the new todo page
}
```

## ç¯å¢ƒå˜é‡

Next.js ä¸­æ·»åŠ ç¯å¢ƒå˜é‡ï¼š

1. é€šè¿‡ `.env.local` åŠ è½½ç¯å¢ƒå˜é‡
2. é€šè¿‡ `NEXT_PUBLIC_` å‰ç¼€åœ¨æµè§ˆå™¨ä¸­è·å–ç¯å¢ƒå˜é‡

### `.env.local` åŠ è½½ç¯å¢ƒå˜é‡

> åœ¨æœåŠ¡ç«¯ç»„ä»¶æˆ–è€…è·¯ç”±å¤„ç†ç¨‹åºä¸­é€šè¿‡ `process.env` è·å–ç¯å¢ƒå˜é‡ï¼›æ— æ³•åœ¨æµè§ˆå™¨ç«¯è·å–

```bash
# .env.local

DB_HOST=localhost

# ç›´æ¥æ¢è¡Œ
PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----
...
Kh9NV...
...
-----END DSA PRIVATE KEY-----"

# ä¹Ÿå¯ä»¥ä½¿ç”¨ `\n`
PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\nKh9NV...\n-----END DSA PRIVATE KEY-----\n"

# ä½¿ç”¨ $å¼•ç”¨å…¶ä»–å˜é‡
TEST_USER=nextjs
TEST_URL=https://TEST.com/$TEST_USER
# æœ¬æ¥å°±è¦ç”¨å¸¦ $çš„å€¼ï¼Œä½¿ç”¨ \$è¿™ç§æ–¹å¼è¿›è¡Œè½¬ä¹‰
```

#### åœ¨æµè§ˆå™¨ä¸­è·å–ç¯å¢ƒå˜é‡

> éœ€è¦åœ¨å˜é‡å‰æ·»åŠ  NEXT*PUBLIC*å‰ç¼€

```tsx
// .env.local
// NEXT_PUBLIC_mashy_id=mashy

// ä½¿ç”¨
"use client";
// app/page.tsx
export default function Page() {
  return (
    <h1
      onClick={() => {
        console.log(process.env.NEXT_PUBLIC_mashy_id);
      }}
    >
      Hello World!
    </h1>
  );
}

// æ³¨æ„ï¼šä½¿ç”¨äº†å˜é‡ï¼ŒåŠ¨æ€æŸ¥æ‰¾çš„å€¼ä¸ä¼šè¢«å†…è”ï¼ï¼ï¼
// ä½¿ç”¨äº†å˜é‡ï¼Œä¸ä¼šè¢«å†…è”ï¼Œä¸ä¼šç”Ÿæ•ˆ
const varName = "NEXT_PUBLIC_ANALYTICS_ID";
setupAnalyticsService(process.env[varName]);

// ä½¿ç”¨äº†å˜é‡ï¼Œä¸ä¼šè¢«å†…è”ï¼Œä¸ä¼šç”Ÿæ•ˆ
const env = process.env;
setupAnalyticsService(env.NEXT_PUBLIC_ANALYTICS_ID);
```

#### é»˜è®¤ç¯å¢ƒå˜é‡

**Next.js æ”¯æŒåœ¨ .envï¼ˆæ‰€æœ‰ç¯å¢ƒï¼‰ã€.env.developmentï¼ˆå¼€å‘ç¯å¢ƒï¼‰ã€.env.productionï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ä¸­è®¾ç½®é»˜è®¤çš„å€¼ã€‚**

**.env.local ä¼šè¦†ç›–è¿™äº›é»˜è®¤å€¼ã€‚**

#### æµ‹è¯•ç¯å¢ƒå˜é‡

> é™¤äº† development ç¯å¢ƒå’Œ production ç¯å¢ƒï¼Œè¿˜æœ‰ç¬¬ä¸‰ä¸ªé€‰é¡¹ï¼Œé‚£å°±æ˜¯ test ç¯å¢ƒã€‚è¿™æ˜¯å½“ä½¿ç”¨æµ‹è¯•å·¥å…·å¦‚ jest æˆ– cypress æ—¶ï¼Œå‡ºäºæµ‹è¯•ç›®çš„è€Œè®¾ç½®ç‰¹å®šçš„ç¯å¢ƒå˜é‡ã€‚

> ç”¨æ³•è·Ÿå¼€å‘ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒç±»ä¼¼ï¼Œå»ºç«‹ä¸€ä¸ª .env.test æ–‡ä»¶ç”¨äºæµ‹è¯•ç¯å¢ƒï¼Œä½†æ˜¯è·Ÿå¼€å‘ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒä¸åŒçš„æ˜¯ï¼Œæµ‹è¯•ç¯å¢ƒä¸ä¼šåŠ è½½ .env.local ä¸­çš„å€¼ï¼Œè¿™æ˜¯ä¸ºäº†è®©æ¯ä¸ªäººéƒ½äº§ç”Ÿç›¸åŒçš„æµ‹è¯•ç»“æœã€‚è¿™äº›é»˜è®¤å€¼ä¼šåœ¨ NODE_DEV è®¾ç½®æˆ test çš„æ—¶å€™ç”¨åˆ°ã€‚

#### ç¯å¢ƒå˜é‡åŠ è½½é¡ºåº

1. `process.env`
2. `.env.$(NODE_ENV).local`
3. `.env.local` (å½“ `NODE_ENV` æ˜¯ `test` çš„æ—¶å€™ä¸ä¼šæŸ¥æ‰¾)
4. `.env.$(NODE_ENV)`
5. `.env`

## ç›®å½•ç»“æ„

1. `/public` ç›®å½•ç»§ç»­æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•
2. `package.jsonã€next.config.jsã€tsconfig.json` ç­‰é…ç½®æ–‡ä»¶ç»§ç»­æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•
3. `.env.*` æ–‡ä»¶ç»§ç»­æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•
4. å¦‚æœ `app` æˆ–è€… `pages` åœ¨æ ¹ç›®å½•ä¸‹å­˜åœ¨ï¼Œ`src/app` æˆ– `src/pages` ä¼šè¢«å¿½ç•¥ã€‚
5. å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ `srcï¼Œä½ å¯èƒ½è¿˜éœ€è¦ç§»åŠ¨å…¶ä»–åº”ç”¨æ–‡ä»¶å¤¹ï¼Œå¦‚` `/components æˆ– /lib`
6. å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ä¸­é—´ä»¶ï¼Œç¡®ä¿å®ƒæ”¾åœ¨ `src` ç›®å½•ä¸‹
7. å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ `Tailwind CSS`ï¼Œåˆ«å¿˜äº†ä¿®æ”¹ `tailwind.config.js` ä¸­çš„ `content` é…ç½®é¡¹

## è·¯ç”±æ®µé…ç½®é¡¹ï¼ˆRoute Segment Configï¼‰

> è·¯ç”±æ®µé…ç½®é€‰é¡¹å¯ä»¥é…ç½®é¡µé¢ã€å¸ƒå±€ã€è·¯ç”±å¤„ç†ç¨‹åºçš„è¡Œä¸º

```tsx
// layout.tsx | page.tsx | route.tsx
export const dynamic = "auto";
export const dynamicParams = true;
export const revalidate = false;
export const fetchCache = "auto";
export const runtime = "nodejs";
export const preferredRegion = "auto";
export const maxDuration = 5;

export default function MyComponent() {}
```

| å˜é‡å            | ç±»å‹                                                                                                                                  | é»˜è®¤å€¼       |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------- | ------------ |
| `dynamic`         | `'auto'` æˆ– `'force-dynamic'` æˆ– `'error'` æˆ– `'force-static'`                                                                        | `'auto'`     |
| `dynamicParams`   | `boolean`                                                                                                                             | `true`       |
| `revalidate`      | `false` æˆ– `'force-cache'` æˆ– `0` æˆ– `number`                                                                                         | `false`      |
| `fetchCache`      | `'auto'` æˆ– `'default-cache'` æˆ– `'only-cache'` æˆ– `'force-cache'` æˆ– `'force-no-store'` æˆ– `'default-no-store'` æˆ– `'only-no-store'` | `'auto'`     |
| `runtime`         | `'nodejs'` æˆ– `'edge'`                                                                                                                | `'nodejs'`   |
| `preferredRegion` | `'auto'` æˆ– `'global'` æˆ– `'home'` æˆ– `string` æˆ– `string[]`                                                                          | `'auto'`     |
| `maxDuration`     | `number `                                                                                                                             | éƒ¨ç½²å¹³å°è®¾ç½® |

### `dynamic`ï¼šæ›´æ”¹å¸ƒå±€æˆ–è€…é¡µé¢çš„åŠ¨æ€è¡Œä¸º

- `'auto'`ï¼ˆé»˜è®¤ï¼‰ï¼šè‡ªåŠ¨åˆ¤æ–­
- `'force-dynamic'`ï¼Œå¼ºåˆ¶åŠ¨æ€æ¸²æŸ“å’Œé€€å‡ºæ‰€æœ‰ `fetch` è¯·æ±‚ç¼“å­˜ï¼Œç›¸å½“äºï¼š
  - Page Router ä¸‹ä½¿ç”¨äº† `getServerSideProps()`
  - å°†å¸ƒå±€æˆ–é¡µé¢ä¸­æ¯ä¸ª `fetch()` è¯·æ±‚éƒ½è®¾ç½®ä¸º `{ cache: 'no-store', next: { revalidate: 0 } }`
  - è®¾ç½®äº†è·¯ç”±æ®µé…ç½® `export const fetchCache = 'force-no-store'`
- `'error'`å¼ºåˆ¶é™æ€æ¸²æŸ“å¹¶ç¼“å­˜æ•°æ®ï¼Œå¦‚æœæœ‰ç»„ä»¶ä½¿ç”¨äº†åŠ¨æ€å‡½æ•°æˆ–ä¸ç¼“å­˜æ•°æ®è¯·æ±‚ï¼ˆuncached data requestï¼‰ï¼Œå°±ä¼šå¯¼è‡´é”™è¯¯ï¼Œç›¸å½“äºï¼š
  - Page Router ä¸‹ä½¿ç”¨äº† `getStaticProps()`
  - å°†å¸ƒå±€æˆ–é¡µé¢ä¸­æ¯ä¸ª `fetch()` è¯·æ±‚éƒ½è®¾ç½®ä¸º `{ cache: 'force-cache' }`
  - è®¾ç½®äº†è·¯ç”±æ®µé…ç½® `fetchCache = 'only-cache', dynamicParams = false`
  - è®¾ç½® `dynamic = 'error'` ä¼šæ›´æ”¹ `dynamicParams` çš„é»˜è®¤å€¼ `true` ä¸º `false`
- `'force-static'` å¼ºåˆ¶é™æ€æ¸²æŸ“å¹¶ç¼“å­˜æ•°æ®ï¼Œå¼ºåˆ¶ `cookies()`ã€`headers()`ã€`useSearchParams()` è¿”å›ç©ºå€¼ã€‚

### `dynamicParams`ï¼šæ§åˆ¶å½“è®¿é—®ä¸æ˜¯ç”± generateStaticParams ç”Ÿæˆçš„åŠ¨æ€è·¯ç”±æ®µçš„æ—¶å€™å‘ç”Ÿä»€ä¹ˆã€‚

- `true`ï¼ˆé»˜è®¤ï¼‰ï¼šæŒ‰éœ€ç”Ÿæˆ
- `false`ï¼šè¿”å› 404

> å¦‚æœä½¿ç”¨äº† `dynamic = 'error'` å’Œ `dynamic = 'force-static'`ï¼Œå®ƒä¼šæ›´æ”¹ `dynamicParams` çš„é»˜è®¤å€¼ä¸º `false`

### `revalidate`ï¼šè®¾ç½®å¸ƒå±€æˆ–è€…é¡µé¢çš„é»˜è®¤éªŒè¯æ—¶é—´

> æ­¤è®¾ç½®ä¸ä¼šè¦†ç›–å•ä¸ª `fetch` è¯·æ±‚è®¾ç½®çš„ `revalidate` çš„å€¼ã€‚æ³¨æ„ `revalidate` é€‰é¡¹åªèƒ½ç”¨äº `Nodejs Runtime`ï¼Œä¸èƒ½ç”¨äº `Edge Runtime`ã€‚

- `false`ï¼ˆé»˜è®¤ï¼‰ï¼Œè¯­ä¹‰ä¸Šç›¸å½“äº `revalidate: Infinity`ï¼Œèµ„æºæ— é™æœŸç¼“å­˜ã€‚
- `0`ï¼Œé¡µé¢æˆ–å¸ƒå±€æ€»æ˜¯åŠ¨æ€æ¸²æŸ“ï¼Œå³ä½¿æ²¡æœ‰ä½¿ç”¨åŠ¨æ€å‡½æ•°æˆ–è€…ä¸ç¼“å­˜æ•°æ®è¯·æ±‚ï¼ˆuncached data requestï¼‰ã€‚
- `number` ï¼šè®¾ç½®å¸ƒå±€æˆ–é¡µé¢çš„é»˜è®¤é‡æ–°éªŒè¯é¢‘ç‡ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚

### `fetchCache`ï¼šä»…å½“ä½ ç‰¹åˆ«éœ€è¦è¦†ç›–é»˜è®¤è¡Œä¸ºæ—¶æ‰åº”è¯¥ä½¿ç”¨

> é»˜è®¤æƒ…å†µä¸‹ï¼ŒNext.js ä¼šç¼“å­˜åœ¨åŠ¨æ€å‡½æ•°ä½¿ç”¨ä¹‹å‰çš„ fetch è¯·æ±‚ï¼Œä¸ä¼šç¼“å­˜ä»»ä½•åŠ¨æ€å‡½æ•°ä¹‹åçš„ fetch è¯·æ±‚ã€‚è€Œ fetchCache å…è®¸ä½ è¦†ç›–å¸ƒå±€æˆ–è€…é¡µé¢ä¸­æ‰€æœ‰çš„ fetch è¯·æ±‚çš„é»˜è®¤ cache é€‰é¡¹ã€‚

- `'auto'`ï¼ˆé»˜è®¤ï¼‰ï¼šåŠ¨æ€å‡½æ•°ä¹‹å‰æŒ‰ç…§å¼€å‘è€…è®¾ç½®çš„ cache é€‰é¡¹è¿›è¡Œç¼“å­˜ï¼ŒåŠ¨æ€å‡½æ•°ä¹‹åä¸ç¼“å­˜è¯·æ±‚
- `'default-cache'`ï¼šå¼€å‘è€…å¯ä»¥è‡ªç”±è®¾ç½® cache é€‰é¡¹ï¼Œä½†å¦‚æœå¼€å‘è€…æœªè®¾ç½® cache é€‰é¡¹ï¼Œé»˜è®¤è®¾ç½®ä¸º force-cacheï¼Œè¿™æ„å‘³ç€å³ä½¿æ˜¯åœ¨åŠ¨æ€å‡½æ•°ä¹‹åçš„è¯·æ±‚ï¼Œä¹Ÿä¼šè¢«è§†ä¸ºé™æ€
- `'only-cache'`ï¼šå¦‚æœå¼€å‘è€…æœªè®¾ç½® cache é€‰é¡¹ï¼Œé»˜è®¤è®¾ç½®ä¸º force-cacheï¼Œå¦‚æœæœ‰è¯·æ±‚è®¾ç½®æˆ cache: 'no-store'ï¼Œåˆ™ä¼šå¯¼è‡´æŠ¥é”™
- `'force-cache'`ï¼šå°†æ‰€æœ‰è¯·æ±‚çš„ cache é€‰é¡¹è®¾ç½®ä¸º force-cache ã€‚
- `'default-no-store'`ï¼šå¼€å‘è€…å¯ä»¥è‡ªç”±è®¾ç½® cache é€‰é¡¹ï¼Œä½†å¦‚æœå¼€å‘è€…æœªè®¾ç½® cache é€‰é¡¹ï¼Œé»˜è®¤è®¾ç½®ä¸º no-storeï¼Œè¿™æ„å‘³ç€å³ä½¿æ˜¯åœ¨åŠ¨æ€å‡½æ•°ä¹‹å‰çš„è¯·æ±‚ï¼Œä¹Ÿä¼šè¢«è§†ä¸ºåŠ¨æ€ã€‚
- `'only-no-store'`ï¼šå¦‚æœå¼€å‘è€…æœªè®¾ç½® cache é€‰é¡¹ï¼Œé»˜è®¤è®¾ç½®ä¸º no-storeï¼Œå¦‚æœæœ‰è¯·æ±‚è®¾ç½®æˆ cache: 'force-cache'ï¼Œåˆ™ä¼šå¯¼è‡´æŠ¥é”™
- `'force-no-store'`ï¼šå°†æ‰€æœ‰è¯·æ±‚çš„ cache é€‰é¡¹è®¾ç½®ä¸º no-store ã€‚

### `runtime`ï¼šè®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒ

### `preferredRegion`ï¼šæŒ‡å®šåŒºåŸŸ

```tsx
// layout.tsx | page.tsx | route.ts
export const preferredRegion = "auto";
// 'auto' | 'global' | 'home' | ['iad1', 'sfo1']
// å…¶ä¸­ iad1 è¡¨ç¤ºç¾å›½ä¸œéƒ¨åŒºåŸŸï¼Œå‚è€ƒä½ç½®ç¾å›½åç››é¡¿åœ°åŒºï¼Œsfo1 è¡¨ç¤ºç¾å›½è¥¿éƒ¨ï¼Œå‚è€ƒä½ç½®ç¾å›½æ—§é‡‘å±±ã€‚
```

### `maxDuration`

> æŒ‡çš„æ˜¯å‡½æ•°åœ¨å“åº”ä¹‹å‰å¯ä»¥å¤„ç† HTTP è¯·æ±‚çš„æœ€é•¿æ—¶é—´ã€‚å¦‚æœæŒç»­æ—¶é—´å†…æ²¡æœ‰å“åº”ï¼Œåˆ™ä¼šè¿”å›é”™è¯¯ç ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œæ ¹æ®ä¸åŒçš„éƒ¨ç½²å¹³å°ï¼Œé»˜è®¤æ—¶é—´ä¼šä¸åŒã€‚

### `generateStaticParams`ï¼šä¸åŠ¨æ€è·¯ç”±æ­é…ä½¿ç”¨ï¼Œç”¨äºå®šä¹‰é™æ€ç”Ÿæˆçš„è·¯ç”±æ®µå‚æ•°

## å†…ç½®ç»„ä»¶ `<Image />`

ä¼˜åŒ–å†…å®¹ï¼š

1. **å°ºå¯¸ä¼˜åŒ–**ï¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªè®¾å¤‡æä¾›æ­£ç¡®å°ºå¯¸çš„å›¾ç‰‡ï¼Œä¹Ÿä¼šä½¿ç”¨ç°ä»£å›¾ç‰‡æ ¼å¼å¦‚ WebP å’Œ AVIFã€‚
2. **è§†è§‰ç¨³å®šæ€§**ï¼šé˜²æ­¢å›¾ç‰‡åŠ è½½æ—¶å‘ç”Ÿå¸ƒå±€åç§»ï¼ˆLayout Shiftï¼‰
3. **æ›´å¿«çš„é¡µé¢åŠ è½½**ï¼šå›¾ç‰‡åªæœ‰åœ¨è¿›å…¥è§†å£çš„æ—¶å€™æ‰ä¼šåŠ è½½ï¼Œä½¿ç”¨æ‡’åŠ è½½åŠŸèƒ½ï¼Œå¹¶å¯é€‰ä½¿ç”¨æ¨¡ç³Šå ä½ç¬¦
4. **çµæ´»é…ç½®**ï¼šæŒ‰éœ€è¿›è¡Œå›¾ç‰‡è°ƒæ•´ï¼Œè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„å›¾ç‰‡ä¹Ÿå¯ä»¥

## `next/font` å­—ä½“

> `next/font` ä¼šè‡ªåŠ¨ä¼˜åŒ–å­—ä½“ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰å­—ä½“ï¼‰ï¼Œå°±æ¯”å¦‚å€ŸåŠ© CSS çš„ `size-adjust` å±æ€§å®ç°é›¶å¸ƒå±€åç§»ã€‚
> `next/font` å…·ä½“åˆåˆ†ä¸º `next/font/google` å’Œ `next/font/local`

## å†…ç½® `<Link>` å’Œ `<Script>` ç»„ä»¶

### `<Link>`

> Link ç»„ä»¶æ˜¯ä¸€ä¸ªæ‹“å±•äº† HTML `<a>` å…ƒç´ çš„ React ç»„ä»¶ï¼Œæä¾›äº†é¢„åŠ è½½å’Œå®¢æˆ·ç«¯è·¯ç”±ä¹‹é—´çš„å¯¼èˆªåŠŸèƒ½ã€‚å®ƒæ˜¯ Next.js è·¯ç”±å¯¼èˆªçš„ä¸»è¦æ–¹å¼

```tsx
// app/page.tsx
import Link from "next/link";

export default function Page() {
  return <Link href="/dashboard">Dashboard</Link>;
}
```

| Prop     | ç¤ºä¾‹              | ç±»å‹             | æ˜¯å¦å¿…é¡» | å¤‡æ³¨                               |
| -------- | ----------------- | ---------------- | -------- | ---------------------------------- |
| href     | href="/dashboard" | String or Object | æ˜¯       | -                                  |
| replace  | replace={false}   | Boolean          | -        | -                                  |
| scroll   | scroll={false}    | Boolean          | -        | -                                  |
| prefetch | prefetch={false}  | Boolean          | -        | åå°é¢„è·å–é¡µé¢(ä»…åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¼€å¯) |

### `<Script>`

> Next.js å†…ç½®çš„è„šæœ¬ç»„ä»¶ï¼Œç”¨äºæ§åˆ¶åŠ è½½å’Œæ‰§è¡Œä¸‰æ–¹è„šæœ¬æ–‡ä»¶

| Prop     | ç¤ºä¾‹                  | ç±»å‹     | æ˜¯å¦å¿…ä¼                                                                              |
| -------- | --------------------- | -------- | ------------------------------------------------------------------------------------ |
| src      | src="xxxx"            | String   | å¿…ä¼ ï¼Œé™¤éä½¿ç”¨å†…è”è„šæœ¬(æ³¨æ„å¿…é¡»ä¸ºå†…è”è„šæœ¬åˆ†é…ä¸€ä¸ª idï¼Œä»¥ä¿è¯ Next.js è¿½è¸ªå’Œä¼˜åŒ–è„šæœ¬) |
| strategy | strategy="lazyOnload" | String   | -                                                                                    |
| onLoad   | onLoad={onLoadFunc}   | Function | -                                                                                    |
| onReady  | onReady={onReadyFunc} | Function | -                                                                                    |
| onError  | onError={onErrorFunc} | Function | -                                                                                    |

### `strategy`

è„šæœ¬åŠ è½½ç­–ç•¥ï¼Œä¸€å…±æœ‰å››ç§ï¼š

1. `beforeInteractive`ï¼š åœ¨å¯äº¤äº’å‰åŠ è½½ï¼Œé€‚ç”¨äºå¦‚æœºå™¨äººæ£€æµ‹ã€`Cookie` ç®¡ç†ç­‰
2. `afterInteractive`ï¼š**é»˜è®¤å€¼**ï¼Œåœ¨å¯äº¤äº’ååŠ è½½ï¼Œé€‚ç”¨äºå¦‚æ•°æ®ç»Ÿè®¡ç­‰
3. `lazyOnload`ï¼šåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´åŠ è½½
4. `worker`ï¼šï¼ˆå®éªŒæ€§è´¨ï¼‰é€šè¿‡ `web worker` åŠ è½½

## `Metadata`

`<meta charset="utf-8" />`

**æ·»åŠ å…ƒæ•°æ®**çš„æ–¹æ³•åˆ†ä¸ºä¸¤ç±»ï¼š

1. åŸºäºé…ç½®çš„å…ƒæ•°æ®ï¼šåœ¨ `layout.js` æˆ– `page.js` ä¸­å¯¼å‡ºä¸€ä¸ªé™æ€ `metadata` å¯¹è±¡(é™æ€å…ƒæ•°æ®)æˆ–è€…ä¸€ä¸ªåŠ¨æ€çš„ `generateMetadata` å‡½æ•°(åŠ¨æ€å…ƒæ•°æ®)ã€‚
2. åŸºäºæ–‡ä»¶çš„å…ƒæ•°æ®ï¼šæ·»åŠ ä¸€ä¸ªé™æ€æˆ–è€…åŠ¨æ€ç”Ÿæˆçš„ç‰¹æ®Šæ–‡ä»¶

é€šè¿‡è¿™äº›é€‰é¡¹ï¼ŒNext.js ä¼šè‡ªåŠ¨ä¸ºé¡µé¢ç”Ÿæˆç›¸å…³çš„ `<head>` å…ƒç´ ã€‚

### åŸºäºé…ç½®çš„å…ƒæ•°æ®ï¼ˆConfig-basedï¼‰

#### é™æ€å…ƒæ•°æ®

> å¯¼å‡ºä¸€ä¸ª Metadata å¯¹è±¡

```tsx
// layout.tsx | page.tsx
export const metadata = {
  title: "...",
  description: "...",
};

export default function Page() {}
```

#### åŠ¨æ€å…ƒæ•°æ®

> åŠ¨æ€å…ƒæ•°æ®æ˜¯æŒ‡ä¾èµ–åŠ¨æ€ä¿¡æ¯å¦‚å½“å‰è·¯ç”±å‚æ•°ã€å¤–éƒ¨æ•°æ®ã€çˆ¶çº§è·¯ç”±æ®µ metadata ç­‰ä¿¡æ¯çš„å…ƒæ•°æ®ã€‚è¦å®šä¹‰åŠ¨æ€å…ƒæ•°æ®ï¼Œéœ€è¦å¯¼å‡ºä¸€ä¸ªåä¸º generateMetadata çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ª Metadata å¯¹è±¡

å‚æ•°ï¼š`props` æŒ‡çš„æ˜¯åŒ…å«å½“å‰è·¯ç”±å‚æ•°çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åˆæœ‰ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯ `params` (åŒ…å«å½“å‰åŠ¨æ€è·¯ç”±å‚æ•°çš„å¯¹è±¡)ï¼Œä¸€ä¸ªæ˜¯ `searchParams`(åŒ…å«å½“å‰ URL æœç´¢å‚æ•°çš„å¯¹è±¡)

```tsx
// app/products/[id]/page.tsx
export async function generateMetadata({ params, searchParams }, parent) {
  // è¯»å–è·¯ç”±å‚æ•°
  const id = params.id;

  // è·å–æ•°æ®
  const product = await fetch(`https://.../${id}`).then((res) => res.json());

  // è·å–å’Œæ‹“å±•çˆ¶è·¯ç”±æ®µ metadata
  const previousImages = (await parent).openGraph?.images || [];

  return {
    title: product.title,
    openGraph: {
      images: ["/some-specific-page-image.jpg", ...previousImages],
    },
  };
}

export default function Page({ params, searchParams }) {}
```

**æ³¨æ„ï¼šæ— è®ºæ˜¯é™æ€å…ƒæ•°æ®è¿˜æ˜¯åŠ¨æ€å…ƒæ•°æ®éƒ½åªåœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­æ”¯æŒã€‚å¦‚æœä¸ä¾èµ–è¿è¡Œæ—¶çš„ä¿¡æ¯ï¼Œåˆ™åº”è¯¥å°½å¯èƒ½ä½¿ç”¨é™æ€å…ƒæ•°æ®æ–¹å¼ã€‚**

### åŸºäºæ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆFile-basedï¼‰

ç‰¹æ®Šæ–‡ä»¶ï¼š

- `favicon.ico`ã€`apple-icon.jpg` å’Œ `icon.jpg`
- `opengraph-image.jpg` å’Œ `twitter-image.jpg`
- `robots.txt`ï¼ˆç«™ç‚¹åœ°å›¾ï¼Œç”¨äºå¸®åŠ©æœç´¢å¼•æ“æ›´é«˜æ•ˆçš„çˆ¬å–ç½‘ç«™ï¼‰
- `sitemap.xml`ï¼ˆç«™ç‚¹åœ°å›¾ï¼Œç”¨äºå¸®åŠ©æœç´¢å¼•æ“æ›´é«˜æ•ˆçš„çˆ¬å–ç½‘ç«™ï¼‰

## æ‡’åŠ è½½

åœ¨ Next.js ä¸­æœ‰ä¸¤ç§æ–¹å¼å®ç°æ‡’åŠ è½½ï¼š

1. ä½¿ç”¨ `React.lazy()` å’Œ `Suspense`
2. ä½¿ç”¨ `next/dynamic` å®ç°åŠ¨æ€å¯¼å…¥

é»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡ç«¯ç»„ä»¶è‡ªåŠ¨è¿›è¡Œä»£ç åˆ†éš”ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨æµå°† UI ç‰‡æ®µé€æ­¥å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥æ‡’åŠ è½½åº”ç”¨äºå®¢æˆ·ç«¯

### ä½¿ç”¨ `React.lazy()` å’Œ `Suspense`

```tsx
import { useState, Suspense, lazy } from "react";
import Loading from "./Loading.js";

const MarkdownPreview = lazy(() =>
  delayForDemo(import("./MarkdownPreview.js"))
);

export default function MarkdownEditor() {
  const [showPreview, setShowPreview] = useState(false);
  const [markdown, setMarkdown] = useState("Hello, **world**!");
  return (
    <>
      <textarea
        value={markdown}
        onChange={(e) => setMarkdown(e.target.value)}
      />
      <label>
        <input
          type="checkbox"
          checked={showPreview}
          onChange={(e) => setShowPreview(e.target.checked)}
        />
        Show preview
      </label>
      <hr />
      {showPreview && (
        <Suspense fallback={<Loading />}>
          <h2>Preview</h2>
          <MarkdownPreview markdown={markdown} />
        </Suspense>
      )}
    </>
  );
}

// æ·»åŠ ä¸€ä¸ªå›ºå®šçš„å»¶è¿Ÿæ—¶é—´ï¼Œä»¥ä¾¿ä½ å¯ä»¥çœ‹åˆ°åŠ è½½çŠ¶æ€
function delayForDemo(promise) {
  return new Promise((resolve) => {
    setTimeout(resolve, 2000);
  }).then(() => promise);
}
```

### ä½¿ç”¨ `next/dynamic`

```tsx
import dynamic from "next/dynamic";

const WithCustomLoading = dynamic(
  () => import("../components/WithCustomLoading"),
  {
    loading: () => <p>Loading...</p>,
    ssr: false, // âš ï¸ è·³è¿‡ ssr
  }
);

export default function Page() {
  return (
    <div>
      <WithCustomLoading />
    </div>
  );
}
```

**æ³¨æ„äº‹é¡¹**ï¼š

1. import() ä¸­çš„è·¯å¾„ä¸èƒ½æ˜¯æ¨¡æ¿å­—ç¬¦ä¸²æˆ–è€…æ˜¯å˜é‡
2. import() å¿…é¡»åœ¨ dynamic() ä¸­è°ƒç”¨
3. dynamic() è·Ÿ lazy() å‡½æ•°ä¸€æ ·ï¼Œéœ€è¦æ”¾åœ¨æ¨¡å—é¡¶å±‚
